{% load static %}
{% load markdownify %}
{% load cl_extras %}

{% comment %} <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/bootstrap-theme.min.css' %}" rel="stylesheet" />
<link href="{% static 'lib/font-awesome-4.7.0/css/font-awesome.min.css' %}" rel="stylesheet" />
<link href="{% static 'css/datatables.min.css' %}" rel="stylesheet" /> {% endcomment %}

<!--   phenotype_clinical_code_lists   -->
  
<div class="col-sm-12 shadow-frame">
	<h3 class="paneltitle" styleXX="margin-top:20px; margin-bottom:20px;">
		<span id="{{ field_data.html_id }}"></span>
	  	<strong>Clinical Code List</strong>
		<div class="dropdown btn-group" style="float: right;">

			{% if concept_data|length > 0 %}
	            <button {% if not user_can_export %} disabled
	                                                 title="Component concept(s) deleted or revoked access!!" {% endif %}
	                                                 type="button" class="btn btn-primary dropdown-toggle"
	                                                 data-toggle="dropdown" aria-haspopup="true"
	                                                 aria-expanded="false" id="export-btn-codelist">
	                Export Code List <i class="caret"></i>
	            </button>
	            <ul class="dropdown-menu">
	                <li>
	                    <a {% if user_can_export %}
	                        href="{% url 'ge_history_phenotype_codes_to_csv' pk=entity.id history_id=entity.history_id %}" {% endif %}
	                        class="dropdown-item">
	                        CSV
	                    </a>
	                </li>
	                <li>
	                    {% if user.is_authenticated %}
	                        <a {% if user_can_export %}
	                            href="{% url 'api:ge_api_export_phenotype_codes_byVersionID' entity.id entity.history_id %}?format=json"
	                            target=_blank {% endif %}
	                    {% else %}
	                        <a {% if user_can_export %}
	                        href="{% url 'api:ge_api_export_published_phenotype_codes' entity.id entity.history_id %}?format=json"
	                        target=_blank {% endif %}
	                    {% endif %}
	                        class="dropdown-item">
	                        JSON
	                    </a>
	                </li>
	                <li>
	                    {% if user.is_authenticated %}
	                        <a {% if user_can_export %}
	                            href="{% url 'api:ge_api_export_phenotype_codes_byVersionID' entity.id entity.history_id %}?format=xml"
	                            target=_blank {% endif %}
	                    {% else %}
	                        <a {% if user_can_export %}
	                        href="{% url 'api:ge_api_export_published_phenotype_codes' entity.id entity.history_id %}?format=xml"
	                        target=_blank {% endif %}
	                    {% endif %}
	                        class="dropdown-item">
	                        XML
	                    </a>
	                </li>
	            </ul>
			{% endif %}
		</div>
	</h3>


	<div class="tab-content">
	    <div id="component-tab-div" class="tab-pane {{ component_tab_active }}" codelist_loaded="{{ codelist_loaded }}">
	    <!-- component-tab-div -->

	        {% if concept_data|length > 0 %}
	        <div class="accordion-option">
	            <a href="javascript:void(0)" class="toggle-accordion active" id="Expand_all">Expand All</a>
	            &nbsp;/&nbsp;
	            <a href="javascript:void(0)" class="toggle-accordion active" id="Collapse_all">Collapse
	                All</a>
	        </div>
	        {% endif %}

             <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                 {% for c in concept_data %}
                     <div class="panel panel-default">
                         <div class="panel-heading" role="tab" id="c{{ c.concept_version_id }}">
                             <div>
                                 <h4 class="panel-title " id="panel-title-c{{ c.concept_version_id }}"
                                     concept_version_id="{{ c.concept_version_id }}">
                                     <a role="button" data-toggle="collapse"
                                        id="sign_c{{ c.concept_version_id }}"
                                        data-parent-xxx="#accordion"
                                        href="#collapse_c{{ c.concept_version_id }}" aria-expanded="true"
                                        aria-controls="collapse_c{{ c.concept_version_id }}">
                                         <i class="plus-minus glyphicon glyphicon-plus"
                                            id="i-c{{ c.concept_version_id }}"></i>
                                         C{{ c.concept_id }}/{{ c.concept_version_id }}
                                     </a>
                                     &nbsp;&nbsp;

                                     <span>
								        <a href="{% url 'concept_history_detail' c.concept_id c.concept_version_id %}"
								                    title="{% url 'concept_history_detail' c.concept_id c.concept_version_id %}"
								                    class="alert-link">
								        {{ c.name }}&nbsp;{{ c.brands|safe }}
								        </a>
								       &nbsp;
								       - {{ c.codingsystem }}
								       &nbsp;
                                                {% if user.is_authenticated %}
                                                    {% if c.is_published %}
                                                        (Published)
                                                    {% endif %}
                                                {% endif %}
                                     </span>

                                     <span>
								        {% if c.alerts|length %}
									 		<div class="alert-danger" role="alert" style=" display:inline-block;">
									           <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
									           <span class="sr-only">Error:</span>
									           {{ c.alerts|safe }}
									        </div>
								 		{% endif %}
								     </span>
                                 </h4>
                             </div>

                         </div>
                         
                         <div id="collapse_c{{ c.concept_version_id }}"
                              codelist_loaded="{{ codelist_loaded }}" target_concept_id="{{ c.concept_id }}"
                              target_concept_history_id="{{ c.concept_version_id }}"
                              class="panel-collapse collapse{% if user.is_authenticated %} pre-scrollable{% endif %}"
                              role="tabpanel" aria-labelledby="c{{ c.concept_version_id }}">
                             <div class="panel-body">
                                 <div class="box-container"><div class="row">
                                     <div class="col-md-6">
                                         <span id="codesCount_c{{ c.concept_version_id }}"
                                               class="codesCount label label-primary">Rows: {{ c.codesCount }}
                                         </span>
                                     </div>
                                 </div></div>
                                 <div>
                                     <table class="table table-striped table-responsive-md code-list-display-table"
                                            style="width: 100%"
                                            id="codelist-tab-table-c{{ c.concept_version_id }}">
                                         <thead>
                                         <tr>
                                             <th>Code</th>
                                             <th>Description</th>
                                             {% for attr_hdr in c.code_attribute_header %}
                                                 <th>{{ attr_hdr }}</th>
                                             {% endfor %}
                                         </tr>
                                         </thead>
                                         <tbody>
                                         {% for code in codelist %}
                                             {% if code.concept_id == c.concept_friendly_id and code.concept_version_id == c.concept_version_id %}
                                                 <tr>
                                                     <td>{{ code.code }}</td>
                                                     <td>{{ code.description|highlight:q }}</td>
                                                     {% if c.code_attribute_header %}

                                                         {% for attr_hdr in c.code_attribute_header %}
                                                             {% for key, value in code.code_attributes.items %}
                                                                 {% if key == attr_hdr %}
                                                                     <td>{{ value }}</td>
                                                                 {% endif %}
                                                             {% endfor %}
                                                         {% endfor %}

                                                     {% endif %}
                                                 </tr>
                                             {% endif %}
                                         {% empty %}
                                             <tr>
                                                 <td colspan="10" class="text-center bg-warning spinner"
                                                     id="no-codes-td">
                                                     {% if codelist_loaded == 0 %}
                                                         Loading ...
                                                     {% else %}
                                                         No codes
                                                     {% endif %}
                                                 </td>
                                             </tr>
                                         {% endfor %}
                                         </tbody>
                                     </table>
                                 </div>
                             </div>
                         </div>
                     </div>
                 {% empty %}
                     <span class="card-no-data">No data available</span>
                 {% endfor %}
             </div>

        <!-- component-tab-div -->
		</div>

	</div>
</div>


<!-- <script src="{% static 'js/lib/jquery/jquery-3.1.1.min.js' %}" type="text/javascript"></script> -->
<script src="{% static 'js/clinicalcode/dataService.js' %}"></script>

<script type="text/javascript">

	function getConceptsCodes(target_concept_id, target_concept_history_id) {
	    if ($('#collapse_c' + target_concept_history_id).attr("codelist_loaded") === "0") {
	        // get the unique codes for the entity version
	        phenotype_id = $('#entity_id_div').attr("entity_id");
	        phenotype_history_id = $('#entity_history_id_div').attr("entity_history_id");
	
	        dataService.get_ge_PhenotypeUniqueCodesByVersion(phenotype_id, phenotype_history_id, target_concept_id, target_concept_history_id, {{ force_highlight_result }}, function (data) {
	            showConceptsCodes(data.concept_codes_html, target_concept_id, target_concept_history_id);
	        });
	
	
	        $('#collapse_c' + target_concept_history_id).attr("codelist_loaded", "1");
	
	    }
	}


	function showConceptsCodes(concept_codes_html_list, target_concept_id, target_concept_history_id) {
	    $.each(concept_codes_html_list, function (i, v) {
	        $('#codelist-tab-table-c' + v.concept_version_id + ' tbody').html(v.c_html);
	        $('#codesCount_c' + v.concept_version_id).text('Rows: ' + v.c_codes_count);
	        
	        var table = $('#codelist-tab-table-c' + v.concept_version_id).DataTable({
	            "initComplete": function () {
	                $('#codelist-tab-table-c' + v.concept_version_id).addClass("specific_tablist")
	            },
	            "scrollX": true,
	            "scrollY": "700px",
	            "scrollCollapse": true,
	            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
	            "colReorder": true,
	            "rowReorder": true,
	            //"fixedHeader": true
	        });	
	    });
     }

</script> 

<script type="text/javascript">
    $(function () {

        $("#Expand_all").on("click", function () {
            $('#accordion .panel-collapse:not(".in")').collapse('show');
            //$('#accordion .panel-collapse').collapse('show');
        });

        $("#Collapse_all").on("click", function () {
            $('#accordion .panel-collapse.in').collapse('hide');
            //$('#accordion .panel-collapse').collapse('hide');
        });

        function toggleIcon(e) {
            getConceptsCodes($(e.target).attr("target_concept_id"), $(e.target).attr("target_concept_history_id"));

            $(e.target)
                .prev('.panel-heading')
                .find(".plus-minus")
                .toggleClass('glyphicon-plus glyphicon-minus');
        }

        $('.panel-group').on('hidden.bs.collapse', toggleIcon);
        $('.panel-group').on('shown.bs.collapse', toggleIcon);


        //$('#accordion .panel-collapse.in').collapse('hide');

        {% if not user.is_authenticated %}
            $('#accordion .panel-collapse:not(".in")').collapse('show');
            
            // Generate standard type of table in code list if not login
            var table = $('.code-list-display-table');
            table.DataTable().destroy();
            table.DataTable({
            	"lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]]
            });
        {% endif%}


    });
</script>


















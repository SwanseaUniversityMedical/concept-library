{% load static %}
{% load compress %}
{% load sass_tags %}
{% load cl_extras %}
{% load entity_renderer %}
{% load markdownify %}
<!--   phenotype_clinical_code_lists   -->

<script src="{% static 'js/clinicalcode/redesign/vendor/simple-datatables/simple-datatables.min.js' %}"></script>

<div class="detailed-input-group fill">
  <div id="export-code-button" class="box-container">

    <div class="row">
      <div class="col-md-6"></div>
      <div class="col-md-6 text-align-right">

          <fieldset class="dropdown-btn">
            <label aria-label="Export code list" role="dropdown" tabindex="0" id="dropdown-label-cl" for="dropdown-opener-cl">
              <input type="radio" class="dropdown-btn__input" name="dropdown-item-cl" id="dropdown-opener-cl"  {% if not user_can_export %} disabled title="Component concept(s) deleted or revoked access!!" {% endif %}>
          
              <!-- dropdown title -->
              <div class="dropdown-btn__label">Export Code List <span class="caret"></span></div>
          
              <input type="radio" class="dropdown-btn__close" name="dropdown-item-cl" id="dropdown-closer-cl">
              <label aria-label="Close dropdown info" role="button" tabindex="0" id="close-dropdown-btn-cl" class="dropdown-btn__close-label" for="dropdown-closer-cl"></label>
          
              <!-- dropdown menu content -->
              <ul class="dropdown-btn__menu fall-right">
                <li aria-label="Export code list as CSV" role="button" tabindex="0">
                  <a {% if user_can_export %}
                    href="{% url 'export_entity_version_codes_to_csv' pk=entity.id history_id=entity.history_id %}" {% endif %}
                    class="dropdown-item">
                    CSV
                  </a>
                </li>
                <li aria-label="Export code list as Json" role="button" tabindex="0">
                  <a {% if user_can_export %}
                      href="{% url 'api:get_generic_entity_field_by_version' entity.id entity.history_id 'codes' %}?format=json"
                      target=_blank {% endif %}
                    class="dropdown-item">
                    JSON
                  </a>
                </li>
                <li aria-label="Export code list as XML" role="button" tabindex="0">
                  <a {% if user_can_export %}
                    href="{% url 'api:get_generic_entity_field_by_version' entity.id entity.history_id 'codes' %}?format=xml"
                    target=_blank {% endif %}
                  class="dropdown-item">
                  XML
                </a>
                </li>
              </ul>
            </label>
          </fieldset>

        </div>
      </div>
      
    </div>
</div>



<div class="detailed-input-group fill">

    <div class="publication-list-group">
      <section class="publication-list-group__list show  "   id="publication-group">
          {% if component.value|length %}
            
                {% for c in component.value %}
                <ul>
                  <li style="padding-top: 15px;">
                    <strong>
                      C{{ c.concept_id }}/{{ c.concept_version_id }}  &nbsp;-&nbsp;            
                    <span>
                      {{ c.details.name }}
                    &nbsp;
                    - ({{ c.coding_system.name }})
                    &nbsp;
                    - ({{c.codelist|length}} codes)
                    &nbsp;
                      {% if user.is_authenticated %}
                          {% if c.is_published %}
                              (Published)
                          {% endif %}
                      {% endif %}
                      </span>
                    </strong>
                  </li>
                </ul>

                  <div class="detailed-input-group fill constrained-codelist-table code-list-display-table" id="concept-{{ c.concept_id }}_{{ c.concept_version_id }}" >
                        
                  </div>
                
                {% endfor %}
            
          {% else %}
            <span class="card-no-data">No Clinical Code Lists</span>
          {% endif %}
      </section>
    </div>

</div>


<script>
      
  document.addEventListener("DOMContentLoaded",function(){
      const conceptData = {{ component.value|jsonify|safe }};
      
      if (conceptData){
        for (var ii = 0; ii < conceptData.length; ii++){
          const c = conceptData[ii];
          container = document.querySelector('#concept-' + c['concept_id'] + '_' + c['concept_version_id']);        
          table = container.appendChild(createElement('table', {
            'id': 'codelist-datatable',
            'class': 'constrained-codelist-table__wrapper',
          }));


          headings = ['Code', 'Description'];
          if (c['details']['code_attribute_headers']){
            for (var i = 0; i < c['details']['code_attribute_headers'].length; i++){
              headings.push(c['details']['code_attribute_headers'][i]);
            }
          }

          columns = [
            { select: 0, type: 'string' },
            { select: 1, type: 'string' },
          ];

          data = []
          codes = c['codelist'];

          data =  codes.map(c => {
            return [c['code'], c['description'], ...c['attributes']]
          });


          new window.simpleDatatables.DataTable(table, {
            perPageSelect: [10, 50, 100, ["All", -1]],
            fixedColumns: false,
            classes: {
              wrapper: "overflow-table-constraint constrained-table",
            }, 
            data: {
              headings: headings,
              data: data,
            }
          });


        }
      }



       

  });
</script>

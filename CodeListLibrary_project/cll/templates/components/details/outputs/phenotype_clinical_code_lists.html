{% load static %}
{% load compress %}
{% load sass_tags %}
{% load cl_extras %}
{% load entity_renderer %}
{% load markdownify %}
<!--   phenotype_clinical_code_lists   -->

<script src="{% static 'js/clinicalcode/redesign/vendor/simple-datatables/simple-datatables.min.js' %}"></script>
<script src="{% static 'js/clinicalcode/redesign/data/conceptUtils.js' %}"></script>

<div class="detailed-input-group fill">
  <div id="export-code-button" class="box-container">

    <div class="row">
      <div class="col-md-6"></div>
      <div class="col-md-6 text-align-right">

          <fieldset class="dropdown-btn">
            <label aria-label="Export code list" role="dropdown" tabindex="0" id="dropdown-label-cl" for="dropdown-opener-cl">
              <input type="radio" class="dropdown-btn__input" name="dropdown-item-cl" id="dropdown-opener-cl"  {% if not user_can_export %} disabled title="Component concept(s) deleted or revoked access!!" {% endif %}>
          
              <!-- dropdown title -->
              <div class="dropdown-btn__label">Export Code List <span class="caret"></span></div>
          
              <input type="radio" class="dropdown-btn__close" name="dropdown-item-cl" id="dropdown-closer-cl">
              <label aria-label="Close dropdown info" role="button" tabindex="0" id="close-dropdown-btn-cl" class="dropdown-btn__close-label" for="dropdown-closer-cl"></label>
          
              <!-- dropdown menu content -->
              <ul class="dropdown-btn__menu fall-right">
                <li aria-label="Export code list as CSV" role="button" tabindex="0">
                  <a {% if user_can_export %}
                    href="{% url 'export_entity_version_codes_to_csv' pk=entity.id history_id=entity.history_id %}" {% endif %}
                    class="dropdown-item">
                    CSV
                  </a>
                </li>
                <li aria-label="Export code list as Json" role="button" tabindex="0">
                  <a {% if user_can_export %}
                      href="{% url 'api:get_generic_entity_field_by_version' entity.id entity.history_id 'codes' %}?format=json"
                      target=_blank {% endif %}
                    class="dropdown-item">
                    JSON
                  </a>
                </li>
                <li aria-label="Export code list as XML" role="button" tabindex="0">
                  <a {% if user_can_export %}
                    href="{% url 'api:get_generic_entity_field_by_version' entity.id entity.history_id 'codes' %}?format=xml"
                    target=_blank {% endif %}
                  class="dropdown-item">
                  XML
                </a>
                </li>
              </ul>
            </label>
          </fieldset>

        </div>
      </div>
      
    </div>
</div>

<div class="detailed-input-group fill constrained">
  {% if component.value|length %}
    {% for c in component.value %}
      <div class="fill-accordian" id="concept-accordian-{{ c.concept_id }}" data-id="{{ c.concept_id }}" data-history-id="{{ c.concept_version_id }}">
        <input class="fill-accordian__input" id="concept-{{ c.concept_id }}-{{ c.concept_version_id }}"
          name="concept-{{ c.concept_id }}-{{ c.concept_version_id }}" type="checkbox" />
        <label class="fill-accordian__label" id="concept-{{ c.concept_id }}-{{ c.concept_version_id }}"
            for="concept-{{ c.concept_id }}-{{ c.concept_version_id }}" role="button" tabindex="0">
          <span>
            <strong>C{{ c.concept_id }}/{{ c.concept_version_id }}</strong>
            &nbsp;-&nbsp;{{ c.details.name }}
            &nbsp;|&nbsp;({{ c.coding_system.name }}, {{ c.codelist|length }} Codes)
            {% if c.is_published %}
              &nbsp;-&nbsp;(Published)
            {% endif %}
          </span>
        </label>
        <article class="fill-accordian__container codelist-extents">
          <div class="detailed-input-group fill constrained" style="max-width: 100%">
            <div class="constrained-codelist-table" id="concept-codelist-{{ c.concept_id }}_{{ c.concept_version_id }}">
            
            </div>
          </div>
        </article>
      </div>
    {% endfor %}
  {% else %}
    <span class="card-no-data">No Clinical Code Lists</span>
  {% endif %}
</div>

<script type="text/javascript">
  const conceptData = {{ component.value|jsonify|safe }};

  domReady.finally(() => {
    if (isNullOrUndefined(conceptData)) {
      return;
    }

    applyCodelistsFromConcepts(
      conceptData,
      {
        codelistContainerId: '#concept-codelist-${concept_id}_${concept_version_id}',
        showAttributes: true,
        perPageSelect: [10, 50, 100, ['All', -1]]
      }
    );
  });
</script>

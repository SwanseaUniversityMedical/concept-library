{% extends "base.html" %}

{% load static %}

{% load cl_extras %}

{% block title %}| Search Phenotypes{% endblock title %}
{% block description %}Search Phenotypes{% endblock description %}
{% block keywords %}Search Phenotypes{% endblock keywords %}	

{% block container_fluid %}

<div class="bg-search">
 	<div class="container" >

		<div id="basic-search" class="bg-search" {% if search_form == 'advanced-form' %} style="display:none;" {% endif %} >
  			<form class="container_frm container-1 example" id="basic-form" action="{% url 'phenotype_list' %}" method="GET"  >
				<div  class="row form-group">
					<div>
						<h2>Phenotypes</h2>
						<div class="form-input-flex-container">
							<input type="text" placeholder="Search Phenotypes - name or ID" name="search" id="search1" value="{{ search|default_if_none:'' }}">
							<input type="hidden" name="tagids" id="tagids"  value="{{ tag_ids|default_if_none:'' }}">
							<input type="hidden" name="selected_phenotype_types" id="selected_phenotype_types"  value="{{ selected_phenotype_types_str|default_if_none:'' }}">
							<input type="hidden" name="search_form" id="collection_search_form1"  class="collection_search_form"  value="{{ search_form }}"> 
							
							<button classXX="btn btn-info" name="page" value="1">
								<i class="fa fa-search"></i>
							</button>
						</div>
					</div>
				</div>
				<div class="row form-group">
					<div >
						<a  id="show-advanced-search" href="javascript:void(null);" >Advanced search</a>
					</div>
				</div>
			</form>
		</div>

	
		<div id="advanced-search" {% if search_form == 'basic-form' %} style="display:none;" {% endif %} > 
			<h2 class="page-header">Phenotypes</h2>
			<form  id="advanced-form" action="{% url 'phenotype_list' %}" method="GET" >
				<div class="panel panel-default bg-search">
					<div class="panel-body container-2">
					
						<div class="row form-group">
							<div class="col-md-2">
								<label for="search">Search:</label>
							</div>
							<div class="col-sm-6">
								<input class="form-control" type="text" placeholder="Phenotype name or ID" name="search" id="search" value="{{ search|default_if_none:'' }}">
							</div>
							<div class="col-md-2">
								<label for="page_size">Results per page:</label>
							</div>
							<div class="col-md-2"> 
								<select class="form-control" id="page_size" name="page_size">
									<option value="20" {% if page_size == "20" %}selected="selected" {% endif %}>20</option>
									<option value="50" {% if page_size == "50" %}selected="selected" {% endif %}>50</option>
									<option value="100" {% if page_size == "100" %}selected="selected" {% endif %}>100</option>
								</select>
								
								<input type="hidden" name="search_form" id="collection_search_form"  class="collection_search_form"  value="{{ search_form }}"> 
								<input type="hidden" name="selected_phenotype_types" id="selected_phenotype_types"  value="{{ selected_phenotype_types_str|default_if_none:'' }}">
								
							</div>
						</div>
						<div class="row form-group">
							<div class="col-sm-2">
								<label for="tag">Tag/Collection:</label>
							</div>
							<div class="col-sm-10">
								<input class="form-control" type="text" name="tagids" id="txtTags" data-role="tagsinput" value="{{ tag|default_if_none:'' }}">
							</div>					
						</div>
						
						<div class="row form-group">
							<div class="col-sm-2">
								<label for="author">Author: <i class="help-block-no-break" style="font-size: 10px;">(free text)</i></label>
							</div>
							<div class="col-sm-6">
								<input class="form-control" type="text" name="author" id="txtAuthor" data-role="authorinput" value="{{ author|default_if_none:'' }}">
							</div>			
							
						{% if user.is_authenticated %}
							<div class="col-md-2">
								<label for="owner">Owner: <i class="help-block-no-break" style="font-size: 10px;">(full user name)</i></label>
							</div>
							<div class="col-md-2"> 
								<input class="form-control" type="text" name="owner" id="txtOwner" data-role="ownerinput" value="{{ owner|default_if_none:'' }}">
							</div>	
						{% endif %}
						</div>
													
<!-- 						<div class="row form-group">							 -->
<!-- 						   <div class="col-sm-2"> -->
<!-- 								<label for="brand">Brand:</label> -->
<!-- 							</div> -->
<!-- 							<div class="col-sm-10"> -->
<!-- 							   {% if request.session.all_brands %} -->
<!-- 								   <ul class="nav navbar-nav"> -->
<!-- 									     <select class="form-control" name="phenotype_brand" id="phenotype_brand"  >   -->
<!-- 										    <option value=""  style='background-color: lightgreen;' >Any</option> -->
<!-- 											{% for brand in request.session.all_brands %} -->
<!-- 												<option value="{{ brand|upper }}"  -->
<!-- 												       {% if brand|upper == phenotype_brand|upper %} selected="selected" {% endif %} -->
<!-- 												       > -->
<!-- 													{{ brand|upper }} -->
<!-- 													{% if brand|upper in request.session.user_brands %} (*) {% endif %} -->
<!-- 											</option> -->
<!-- 											{% empty %} -->
<!-- 												<option value="-1" >No Brands !!!</option> -->
<!-- 											{% endfor %} -->
<!-- 										  </select> -->
<!-- 									</ul> -->
<!-- 								{% endif %} -->
<!-- 								<span id="phenotype_brand_img"> -->
<!-- 								{% if phenotype_brand|length %}  -->
<!-- 									&nbsp; <img height="29px" src="{% static 'img/brands/' %}{{phenotype_brand|upper}}/logo.png" title="{{phenotype_brand|upper}}" alt="{{phenotype_brand|upper}}" />  -->
<!-- 								{% endif %} -->
<!-- 								</span> -->
<!-- 							</div>	 -->
<!-- 						</div> -->
						
						<div class="row form-group">
							{% if user.is_authenticated %}
								<div class="col-md-4">
									<div class="checkbox">
										<label>
											<input id="show_deleted_phenotypes_hidden" type="hidden" name="show_deleted_phenotypes"  value="{{ show_deleted_phenotypes }}" >
											<input class="form-checkbox" id="show_deleted_phenotypes" type="checkbox" nameXX="show_deleted_phenotypes" {% if show_deleted_phenotypes == "1" %} checked="checked" {% endif %} value="1" >
											Show deleted phenotypes
										</label>
									</div>
								</div>


								<div class="col-md-4">
									<div class="checkbox">
										<label>
											<input id="show_my_phenotypes_hidden" type="hidden" name="show_my_phenotypes"  value="{{ show_my_phenotypes }}" >
											<input class="form-checkbox" id="show_my_phenotypes" type="checkbox" nameXX="show_my_phenotypes" {% if show_my_phenotypes == "1" %} checked="checked" {% endif %} value="1" >
											Only show phenotypes owned by me
										</label>
									</div>
								</div>

                        {% endif %}
							
		<!-- 					<div class = "col-md-3">    -->
		<!-- 						<div class="checkbox"  > -->
		<!-- 							<label> -->
		<!-- 								<input id="show_only_validated_phenotypes_hidden" type="hidden" name="show_only_validated_phenotypes"  value="{{ show_only_validated_phenotypes }}" > -->
		<!-- 								<input class="form-checkbox" id="show_only_validated_phenotypes" type="checkbox" nameXX="show_only_validated_phenotypes" {% if show_only_validated_phenotypes == "1" %} checked="checked" {% endif %} value="1" > -->
		<!-- 								Only Show validated phenotypes -->
		<!-- 							</label> -->
		<!-- 						</div> -->
		<!-- 					</div>			 -->
		
						{% if user.is_authenticated %}
							<div  class = "col-md-4">
								<div class="checkbox"  >
									<label>
										<input id="phenotype_must_have_published_versions_hidden" type="hidden" name="phenotype_must_have_published_versions"  value="{{ phenotype_must_have_published_versions }}" >
										<input class="form-checkbox" id="phenotype_must_have_published_versions" type="checkbox" nameXX="phenotype_must_have_published_versions" {% if phenotype_must_have_published_versions == "1" %} checked="checked" {% endif %} value="1" >
										Only show phenotypes with published version
									</label>
								</div>
							</div>		
						{% endif %}								
						</div>
						
					{% if user.is_authenticated %}
					<fieldset class="approval-border">
						 <legend class="approval-border">&nbsp;Publish approval&nbsp;</legend>
						<div class="row form-group" id="approval_div">
						 {% if request.user|has_group:"Moderators" %}
						 	<div class="col-md-4">
								<div class="checkbox">
									<label>
										<input id="show_mod_pending_phenotypes_hidden" type="hidden" name="show_mod_pending_phenotypes"  value="{{ show_mod_pending_phenotypes }}" >
										<input class="form-checkbox" id="show_mod_pending_phenotypes" type="checkbox" nameXX="show_mod_pending_phenotypes" {% if show_mod_pending_phenotypes == "1" %} checked="checked" {% endif %} value="1" >
										Only show phenotypes waiting for approval 
									</label>
								</div>
							</div>						
	                    {% else %}
							<div class="col-md-4">
								<div class="checkbox">
									<label>
										<input id="show_my_pending_phenotypes_hidden" type="hidden" name="show_my_pending_phenotypes" value="{{ show_my_pending_phenotypes }}" >
										<input class="form-checkbox" id="show_my_pending_phenotypes" type="checkbox" nameXX="show_my_pending_phenotypes" {% if show_my_pending_phenotypes == "1" %} checked="checked" {% endif %} value="1" >
										Only show my phenotypes pending for approval 
									</label>
								</div>
							</div>
                      	{% endif %}
                      		<div class="col-md-4">
								<div class="checkbox">
									<label>
										<input id="show_rejected_phenotypes_hidden" type="hidden" name="show_rejected_phenotypes"  value="{{ show_rejected_phenotypes }}" >
										<input class="form-checkbox" id="show_rejected_phenotypes" type="checkbox" nameXX="show_rejected_phenotypes" {% if show_rejected_phenotypes == "1" %} checked="checked" {% endif %} value="1" >
										Include rejected phenotypes
									</label>
								</div>
							</div>	
						</div>	
					</fieldset>	
					{% endif %}	
						
						
						<div class="row form-group">
							<div class="col-md-2 ">
								<a  id="show-basic-search" href="javascript:void(null);" >Basic search</a>
							</div>				
							<div class="col-md-10 text-right">				
								<a class="btn btn-info" name="reset-form" id="reset-form" >
									<i class="glyphicon glyphicon-repeat"></i> Reset							
								</a>
								
								<button class="btn btn-primary" name="page" value="1">
									<i class="fa fa-search"></i> Search Phenotypes
								</button>
							</div>					
						</div>		
					
					</div>
				</div>
			</form>			
		</div>	


	</div>	
</div>	
{% endblock container_fluid %}

{% block container %}
			
		
		<br/>

{% include './index-cards.html' %}
				
{% endblock container %}



{% block scripts %}
	<script src="{% static 'js/clinicalcode/component.js' %}"></script>
	<script src="{% static 'js/clinicalcode/tags.js' %}"></script>
	
	<script type="text/javascript">
		tagService.initialize();
		
		$(function(){
			{% for tag in tags %}
				$('#txtTags').tagsinput('add', {'id': {{ tag.id }}, 'description': '{{ tag.description }}', 'display': '{{ tag.get_display_display }}'});
			{% endfor %}
		});	
		//--------------------------------	

		var imgPath = '&nbsp; <img height="29px" src="{% static 'img/brands/' %}BRANDT1/logo.png"  title="BRANDT1" alt="BRANDT1" /> ';
		$('#phenotype_brand').on('change', function(e){
			if(this.value==''){
				 $('#phenotype_brand_img').html('');
			 } else {
				 $('#phenotype_brand_img').html(imgPath.replace(/BRANDT1/ig, this.value ) );
			 }
		});

	</script>
	
	<script type="text/javascript">
		$('#reset-form').click(function() {
			 
			$("input[id^='search']").val('');		
			$('#page_size').val('20');
						
			$('#txtTags').tagsinput('removeAll');
			
			$('#txtAuthor').val('');
			
			$('#phenotype_brand').val('');
			$('#phenotype_brand_img').html('');
						
			{% if user.is_authenticated %}
				$('#show_deleted_phenotypes').prop("checked", false);
				$('#show_deleted_phenotypes_hidden').val("0");
				
				$('#show_my_phenotypes').prop("checked", false);
				$('#show_my_phenotypes_hidden').val("0");
				
				$('#show_my_pending_phenotypes').prop("checked", false);
				$('#show_my_pending_phenotypes_hidden').val("0");

				$('#show_mod_pending_phenotypes').prop("checked", false);
				$('#show_mod_pending_phenotypes_hidden').val("0");
				
				$('#show_rejected_phenotypes').prop("checked", false);
				$('#show_rejected_phenotypes_hidden').val("0");				

				$('#phenotype_must_have_published_versions').prop("checked", false);
				$('#phenotype_must_have_published_versions_hidden').val("0");

				$('#txtOwner').val('');
			{% endif %}						
			
			$('#show_only_validated_phenotypes').prop("checked", false);
			$('#show_only_validated_phenotypes_hidden').val("0");

		});
		

		{% if search_form == 'advanced-form' %}
			$("#basic-search").hide();
		{% else %}
			$("#advanced-search").hide();
		{% endif %}
			

		$(document).ready(function() {
			$("#show-advanced-search").click(function(){
				  $("#advanced-search").toggle();
				  $("#basic-search").toggle();
				  $(".collection_search_form").val('advanced-form');
			});
			
			$("#show-basic-search").click(function(){
				  $("#advanced-search").toggle();
				  $("#basic-search").toggle();
				  $(".collection_search_form").val('basic-form');				  
			});
		});		
					
	</script>
			

	
	<script type="text/javascript">
		// check if all elements in array 'arr1' are included in array 'arr2'
		function isSubset(arr1, arr2){
		  return arr1.every(i => arr2.includes(i));
		}

		//------------------------------------------
		$(".filter_option").change(function() {

				if($(this).prop('id') == 'checkAll_collections'){
				    $(".filter_option.collections").prop('checked', $(this).prop('checked'));
				}else if($(this).prop('id') == 'checkAll_types'){
				    $(".filter_option.types").prop('checked', $(this).prop('checked'));
				}else{				
					if($(this).prop('name') == 'collection_id'){//alert('col');
						if(!$(this).prop('checked')){
							if($("#checkAll_collections").prop('checked')){
								$("#checkAll_collections").prop('checked', false);
							}
						}
					}else if($(this).prop('name') == 'type_name'){//alert('type');
						if(!$(this).prop('checked')){
							if($("#checkAll_types").prop('checked')){
								$("#checkAll_types").prop('checked', false);
							}
						}
					}
				}
						
				
		         var selected_collections = []
		         $("input:checkbox[name=collection_id]:checked").each(function(){
		        	 selected_collections.push(parseInt($(this).val()));
		         });

		         var selected_phenotype_types_2 = []
		         $("input:checkbox[name=type_name]:checked").each(function(){
		        	 selected_phenotype_types_2.push($(this).val());
		         });
		         
		        // alert(selected_phenotype_types_2);
		         
		         //$("#filter_form input[id=tagids]").val(selected_collections);
		         
		         
		        var all_tags = [];
				{% for tag in allTags %}
					tg = {"id": {{ tag.id }}, "description": "{{ tag.description }}", "display": "{{ tag.get_display_display }}" };
					all_tags.push(tg);
				{% endfor %}	   
				
				if($("#collection_search_form1").val() == 'advanced-form'){
						
						//first - remove all associated collections
						{% for tag in brand_associated_collections %}
							$('#txtTags').tagsinput('remove', {'id': {{ tag.id }}, 'description': '{{ tag.description }}'});
						{% endfor %}
						
						
						for (let t = 0; t < all_tags.length; t++) { 
							for( let c = 0; c < selected_collections.length; c++) { 
								if(selected_collections[c] == all_tags[t].id){
									$('#txtTags').tagsinput('add', {'id': all_tags[t].id , 'description': all_tags[t].description, 'display': all_tags[t].display} );
								}
							}
						}

						if(isSubset({{ brand_associated_collections_ids|safe }}, selected_collections)){
							$("#checkAll_collections").prop('checked', true);
						}
//alert('srv='+{{ selected_phenotype_types|safe }});

						if(isSubset({{ phenotype_types|safe }}, selected_phenotype_types_2)){
							$("#checkAll_types").prop('checked', true);
						}
						
						$("#advanced-form input[id=selected_phenotype_types]").val(selected_phenotype_types_2.join());
						
						//alert('adv');
						$("#advanced-form").submit();
						
				}else{
						$("#basic-form input[id=tagids]").val(selected_collections);
	
						if(isSubset({{ brand_associated_collections_ids|safe }}, selected_collections)){
							$("#checkAll_collections").prop('checked', true);
						}

						
						if(isSubset({{ phenotype_types|safe }}, selected_phenotype_types_2)){
							$("#checkAll_types").prop('checked', true);
						}
						
						$("#basic-form input[id=selected_phenotype_types]").val(selected_phenotype_types_2.join());

						//alert('basic');
						$("#basic-form").submit();
				}
			
		});	
		
		//--------------------
		// change checkbox's hidden value when checked/unchecked
		$(".form-checkbox").change( function() { 
		  if ( $(this).is(":checked") ) {
			  $("#" + $(this).attr('id') + "_hidden").val('1');
		  } else if ( $(this).not(":checked") ) {
			  $("#" + $(this).attr('id') + "_hidden").val('0');
		  }
		});
		
				
		
			
	</script>
	
	
	{% endblock scripts %}


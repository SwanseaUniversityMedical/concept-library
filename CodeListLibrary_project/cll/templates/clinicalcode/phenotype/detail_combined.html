{% extends "base.html" %}

{% load staticfiles %}
{% load markdownify %}

{% block title %}| Historical phenotype{% endblock title %}

{% block container %}

{% if user.is_authenticated and not is_latest_version  %}
	<h2 style="background-color:silver; padding-left:5px;"><i class="fa fa-history" aria-hidden="true"></i><i> {{ phenotype.name }} <br>(Historical version)</i>
{% else %}
	<h2><i class="fa fa-file-o" aria-hidden="true"></i><i> {{ phenotype.name }} </i>		
{% endif %}	
	{% for item in request.BRAND_GROUPS %}
		{% for brand, groups in item.iteritems %}
			{% if phenotype.group.name in groups %}
			<img style="margin-top:-5px;" src="{% static 'img/brands/' %}{{brand}}/logo.png" height="29px" title="{{brand}}" alt="{{brand}}" />
			{% endif %}
		{% endfor %}
	{% endfor %}
</h2>

<div class="panel panel-default">
	<div class="panel-body">
		<div class="row">
			<div class="col-md-12">
				<div class="form-horizontal">
					<!--
					<div class="form-group">
						<label class="col-sm-3" for="">Name:</label>
						<div class="col-sm-9">
							{{ phenotype.name }}						
						</div>
					</div>
					 -->		
				  <span id="topButtons">			
					<div class="row">
						<div class="col-sm-10">
							<a href="{% url "phenotype_list" %}" class="btn btn-success">
								<i class="fa fa-reply" aria-hidden="true"></i> Return to list
							</a>
							
						   <div class="dropdown btn-group" > 
							  <button {% if not user_can_export %} disabled title="Component phenotype(s) deleted or revoked access!!" {% endif %} type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="export-btn">
							    Export
							    <span class="caret"></span>
							  </button>
							  <ul class="dropdown-menu">
							  <li>
							    <a {% if user_can_export %} href="{% url 'history_phenotype_codes_to_csv' pk=phenotype.id phenotype_history_id=phenotype.history_id %}" {% endif %} 
							       class="dropdown-item" >
									<i class="fa fa-file-excel-o" aria-hidden="true"></i> CSV
								</a>
							   </li>
							   <li>
							   {% if user.is_authenticated %}
									<a {% if user_can_export %} href="/api/export_phenotype_codes_byVersionID/{{ phenotype.id }}/version/{{ phenotype.history_id }}/?format=json" target=_blank {% endif %}
							   {% elif enable_publish %}
									<a {% if user_can_export %} href="/api/export_published_phenotype_codes/{{ phenotype.id }}/version/{{ phenotype.history_id }}/?format=json" target=_blank {% endif %}							    
							   {% endif %}
								       class="dropdown-item" >
										<i class="fa fa-file-text" aria-hidden="true"></i> JSON
									</a>
							   </li>
							   <li>
							   {% if user.is_authenticated %}
									<a {% if user_can_export %} href="/api/export_phenotype_codes_byVersionID/{{ phenotype.id }}/version/{{ phenotype.history_id }}/?format=xml" target=_blank {% endif %} 
							   {% elif enable_publish %}
									<a {% if user_can_export %} href="/api/export_published_phenotype_codes/{{ phenotype.id }}/version/{{ phenotype.history_id }}/?format=xml" target=_blank {% endif %}							    
							   {% endif %}							   
							       class="dropdown-item" >
									<i class="fa fa-file-code-o" aria-hidden="true"></i> XML
								</a>
							   </li>
							  </ul>
							</div>
							
					{% if user.is_authenticated and not CLL_READ_ONLY %}
							
							{% if enable_publish %}
								{% if is_published %}
							    	<a class="btn btn-success" disabled title="This version is already published" >
								    	<i class="fa fa-paper-plane" aria-hidden="true"></i>							    		
								    	&nbsp;Published&nbsp;
								    	<span class="glyphicon glyphicon-ok" style="color:green"></span>
								    </a>
								{% else %}
									<a 
								    {% if not live_ver_is_deleted and not is_published %}
								    	class="js-load-modal btn btn-primary" href="{% url 'phenotype_publish' pk=phenotype.id phenotype_history_id=phenotype.history_id %}"  
									{% else %}
										class="btn btn-primary" disabled 
										{% if is_published %}
									    	title="This version is already published" 
										{% elif live_ver_is_deleted %}
											title="Deleted phenotypes cannot be published !!"
										{% endif %} 
									{% endif %} 
									 id="publish2" >
									<i class="fa fa-paper-plane" aria-hidden="true"></i> Publish 
								   </a>
								{% endif %}
								
							{% endif %}
							
					 {% endif %}
					 	
						 	
					
						</div>
						<div class="col-md-2 text-right">
							<a id="printBtn" class="btn btn-primary">
								<i class="fa fa-print" aria-hidden="true"></i> Print
							</a>
							<a href="#" role="button" class="btn popovers" id="help-hist-phenotype" data-toggle="popover" data-trigger="hover" data-container="body" title="" data-original-title="" data-placement="right">
								<i class="fa fa-question-circle" aria-hidden="true"></i>
							</a>
						</div>
					</div>
			
					<div class="alert alert-success alert-dismissable" id="success-message" style="display: none;" role="alert"></div>
					<div class="alert alert-danger alert-dismissable" id="error-message" style="display: none;" role="alert"></div>
					<hr/>	
				</span>
				
 					<div class="form-group highlight-row">
						<label class="col-sm-3">ID:</label>
						<div class="col-sm-9" id="phenotype_id_div" phenotype_id="{{ phenotype.id }}">
							{{ phenotype.id }}						
						</div>
					</div>
										
 					<div class="form-group">
						<label class="col-sm-3">Version ID:</label>
						<div class="col-sm-9" id="phenotype_history_id_div" phenotype_history_id="{{ phenotype.history_id }}">
							{{ phenotype.history_id }} 
							{% if user.is_authenticated %}
								{% if is_latest_version  %}
									&nbsp;&nbsp;
									&nbsp;&nbsp;
									<span class="tag label label-success" style='color:yellow;' >
									(latest version &nbsp;&nbsp; <span class="glyphicon glyphicon-asterisk" aria-hidden="true"></span>)
									</span> 
								{% else %}		
									&nbsp;&nbsp;
									&nbsp;&nbsp;
									<span class="tag label label-default" style='color:yellow;' >
									(Historical version &nbsp;&nbsp; <span class="fa fa-history" aria-hidden="true"></span>)
									</span> 
								{% endif %}				
							{% endif %}				
						</div>
					</div>

					<div class="form-group highlight-row">
						<label class="col-sm-3">Tags:</label>
						<div class="col-sm-9">
							{% for tag in tags %}
							   <span class="tag label label-{{ tag.get_display_display }}">{{ tag.description }}</span>
							{% endfor %}						
						</div>
					</div>
					
                    <div class="form-group">
						<label class="col-sm-3">Type:</label>
						<div class="col-sm-9">
							{{ phenotype.type }}						
						</div>
					</div>					

                   <div class="form-group highlight-row">
						<label class="col-sm-3">Data Sources:</label>
						<div class="col-sm-9">
							{% for ds in data_sources %}
							   <span class="tag label">
							   		{% if ds.url %}
							   			<a  href="{{ ds.url }}" target=_blank >{{ ds.name }}</a>
							   		{% else %}
							   			{{ ds.name }}
							   		{% endif %} 
							   </span><br>
							{% endfor %}							
						</div>
					</div>


                   <div class="form-group ">
						<label class="col-sm-3">Clinical Terminologies:</label>
						<div class="col-sm-9">
							{% for ct in clinicalTerminologies %}
							   <span class="tag label label-info">{{ ct.name }}</span>
							{% endfor %}	
						</div>
					</div>


					<div class="form-group highlight-row">
						<label class="col-sm-3" for="">Author:</label>
						<div class="col-sm-9">
							{{ phenotype.author }}						
						</div>
					</div>
					
					{% if not user.is_authenticated  %}
						<div class="form-group ">
							<label class="col-sm-3">Owner:</label>
							<div class="col-sm-9">
								{{ phenotype.owner.username }}
							</div>
						</div>
					{% endif %}	
					
					{% if user.is_authenticated  %}
						<div class="form-group ">
							<label class="col-sm-3">Entry date:</label>
							<div class="col-sm-9">
								{{ phenotype.entry_date }}							
							</div>
						</div>
					{% endif %}	
					
                    <div class="form-group highlight-row">
						<label class="col-sm-3">Agreement Date:</label>
						<div class="col-sm-9">
							{{ phenotype.hdr_modified_date }}
						</div>
					</div>

                    <div class="form-group ">
						<label class="col-sm-3">UUID:</label>
						<div class="col-sm-9">
							{{ phenotype.phenotype_id }}
						</div>
					</div>
					
					<div class="form-group highlight-row">
						<label class="col-sm-3">Validation performed:</label>
						<div class="col-sm-9">
							<input type="checkbox" {% if phenotype.validation_performed %}checked="checked"{% endif %} disabled />
						</div>
					</div>

                    <div class="form-group ">
						<label class="col-sm-3">Validation:</label>
						<div class="col-sm-9">
							{{ phenotype.validation }}
						</div>
					</div>


                    <div class="form-group highlight-row">
						<label class="col-sm-3">Valid Event Data Range:</label>
						<div class="col-sm-9">
							{{ phenotype.valid_event_data_range_start }} - {{ phenotype.valid_event_data_range_end }}
						</div>
					</div>
										
					<div class="form-group">
						<label class="col-sm-3">Primary publication DOI:</label>
						<div class="col-sm-9">
							{{ phenotype.publication_doi }}							
						</div>
					</div>
					
					<div class="form-group  highlight-row">
						<label class="col-sm-3">Primary publication link:</label>
						<div class="col-sm-9">
							{{ phenotype.publication_link }}
						</div>
					</div>
					
<!-- 					<div class="form-group "> -->
<!-- 						<label class="col-sm-3">Secondary  publication links:</label> -->
<!-- 						<div class="col-sm-9"> -->
<!-- 							{{ phenotype.secondary_publication_links }} -->
<!-- 						</div> -->
<!-- 					</div> -->
					

					<div class="form-group">
						<label class="col-sm-3">Source reference:</label>
						<div class="col-sm-9">
							{{ phenotype.source_reference }}
						</div>
					</div>
					
					<div class="form-group highlight-row">
						<label class="col-sm-3">Citation requirements:</label>
						<div class="col-sm-9">
							{{ phenotype.citation_requirements }}
						</div>
					</div>
					
					{% if user.is_authenticated  %}
						<div class="form-group  ">
							<label class="col-sm-3">Created by:</label>
							<div class="col-sm-3">
							 	{{ phenotype.created_by_username }}
							</div>
							<label class="col-sm-2 ">On:</label>
							<div class="col-sm-4">
							 	{{ phenotype.created }}
							</div>
						</div>
						<div class="form-group  highlight-row">
							<label class="col-sm-3">Modified by:</label>
							<div class="col-sm-3">
								{{ phenotype.modified_by_username }}
							</div>
							<label class="col-sm-2">On:</label>
							<div class="col-sm-4">
							 	{{ phenotype.modified }}
							</div>
						</div>
					
						<hr />
						<div id="permissions" class="form-group ">
							<label class="col-sm-3 ">Owner:</label>
							<div class="col-sm-3">
								{{ phenotype.owner.username }}
							</div>
							<label class="col-sm-2">Owner access:</label>
							<div class="col-sm-4">								
								{% if phenotype.owner_access == 1 %}	
									<span>None</span>
								{% elif phenotype.owner_access == 2 %}
									<span>View only</span>
								{% elif phenotype.owner_access == 3 %}
									<span>View and edit</span>
								{% else %}
									
								{% endif %}
							</div>
						</div>
						
						<div id="permissions" class="form-group  highlight-row">
							<label class="col-sm-3">Group:</label>
							<div class="col-sm-3">
								{{ phenotype.group }}
							</div>
							<label class="col-sm-2">Group access:</label>
							<div class="col-sm-4">
								{% if phenotype.group_access == 1 %}	
									<span>No access</span>
								{% elif phenotype.group_access == 2 %}
									<span>View only</span>
								{% elif phenotype.group_access == 3 %}
									<span>View and edit</span>
								{% else %}
									
								{% endif %}
							</div>
						</div>
						
						<div id="permissions" class="form-group ">
							<label class="col-sm-3">Everyone else access:</label>
							<div class="col-sm-9">
								{% if phenotype.world_access == 1 %}	
									<span>No access</span>
								{% elif phenotype.world_access == 2 %}
									<span>View only</span>
								{% elif phenotype.world_access == 3 %}
									<span>View and edit</span>
								{% else %}
									
								{% endif %}
							</div>
						</div>
						 	
					{% endif %}	
					
					<hr />

         <div >
             {{ phenotype.implementation|markdownify }}
         </div>
                    <h3><i aria-hidden="true"></i> Implementation</h3>
                    <div class="markdown-holder">
                        {{ phenotype.implementation|markdownify }}
                    </div>

					<hr />

                    <h3><i aria-hidden="true"></i> Publications</h3>
                    <div class="markdown-holder">
                        {{ phenotype.secondary_publication_links|markdownify }}
                    </div>
                    					
					<hr/>
					
<!-- 					<h3><i aria-hidden="true"></i> Concepts</h3> -->
					<input type="hidden" id="concepts_json" value="{{ phenotype.concept_informations }}">
					<input type="hidden" id="concepts_id_name" value="{{ concepts_id_name }}">
<!--  					<input type="hidden" id="concepts_id_versionID"  value="{{ concepts_id_versionID }}">  -->

					
										
				<ul class="nav nav-tabs tabs-up" role="tablist">
				  <li class="nav-item {{ component_tab_active }}">
				    <a href="#component-tab-div" data-toggle="tab" id="componentstab" data-target="#component-tab-div" class="media_node {{ component_tab_active }} span">
				    	<h4><i class="fa fa-cogs" aria-hidden="true"></i> Concepts</h4>
					</a>
				  </li>
				  <li class="nav-item {{ codelist_tab_active }}"  >
				    <a href="#codelist-tab-div" data-toggle="tab" id="codelisttab" data-target="#codelist-tab-div" class="media_node {{ codelist_tab_active }} span">
				    	<h4><i class="fa fa-barcode" aria-hidden="true"></i> Code List</h4>
				    </a>
				  </li>
				</ul>
				<div class="tab-content">
					<div id="component-tab-div" class="tab-pane {{ component_tab_active }}" >
						<br>
						<table class="table table-striped small-table table-hover" id="concept_table"  idx="component-table">
							<thead>
								<tr>
									<th>&nbsp;</th>
									<th>Concept id</th>
	 								<th>Concept version id 00published00</th> 
									<th>Concept name</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									
								</tr>
							</tbody>
						</table>
					</div>
					
					<div id="codelist-tab-div" codelist_loaded="{{ codelist_loaded }}" class="tab-pane {{ codelist_tab_active }} " >
						<div class="row">
						<br>
							<div class="col-md-6">
								<span class="codesAmount label label-primary">Rows: {{ codelist|length }}</span>
							</div>
						</div>
						
						<div id="codelist-div-container" {% if user.is_authenticated %} class="pre-scrollable" {% endif %} >						
							<table class="table table-striped small-table" id="codelist-tab-table" >
								<thead>
									<tr>
										<th>Code</th>
										<th>Description</th>
										<th>Coding System</th>
									</tr>
								</thead>
								<tbody>
								{% for code in codelist %}
									<tr>
										<td>{{ code.code }}</td>
										<td>{{ code.description }}</td>
										<td>{{ code.coding_system }}</td>		
									</tr>
								{% empty %}
									<tr>
										<td colspan="3" class="text-center bg-warning spinner" id="no-codes-td">
											{% if codelist_loaded == 0 %}
											    Loading ...
											{% else %}
												No codes
											{% endif %} 											
										</td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
							
						</div>
					</div>
					
				</div>
					  
					<div class="form-group">
						<div class="col-xs-offset-3 col-sm-6">
							<a href="{% url 'phenotype_list' %}" class="btn btn-success">
								<i class="fa fa-reply" aria-hidden="true"></i> Return to list
							</a>
						
<!-- 						{% if user.is_authenticated and not CLL_READ_ONLY %} -->
<!-- 							&nbsp;&nbsp; -->
<!-- 							<span> -->
<!-- 								<a {% if user_can_edit %}href="{% url 'phenotype_update' phenotype.id %}"{% endif %} class="btn btn-primary" -->
<!-- 									{% if not user_can_edit %} disabled {% endif %} > -->
<!-- 									<i class="fa fa-edit" aria-hidden="true"></i> Edit phenotype -->
<!-- 								</a> -->
<!-- 							</span>						  -->
<!-- 						{% endif %} -->
						</div>
					</div>		
					
					
				</div>
			</div>
		</div>
		
	<!--	-------------------------------------------------------------------
			CHANGE HISTORY
			-------------------------------------------------------------------
	  -->
	  	  	<span id="history-section">
				<hr/>
				<div class="row">
					<div class="col-sm-11" id="help-phenotype-history-container">
						<h3><i class="fa fa-history" aria-hidden="true"></i> versions</h3>
					</div>
					<div class="col-sm-1 text-right">
						<a href="#" role="button" class="popovers" id="help-phenotype-history" data-container="#help-phenotype-history-container" data-toggle="popover" data-trigger="hover" title="" data-original-title="Change history" data-placement="left">
							<i class="fa fa-question-circle" aria-hidden="true"></i>
						</a>
					</div>
				</div>		
				<div class="pre-scrollable">		
					{% include '../phenotype/partial_history_list.html' %}
			    </div>	
			</span>
				
			</div>
		</div>
	<!--	-------------------------------------------------------------------
			HELP POP-UP TEXTS
			-------------------------------------------------------------------
	  -->
	  		
		<div id="popover-content-help-hist-phenotype" class="hide popover-lg">
			<p>
				<strong>Return to list</strong> - returns to the phenotype search page.
			</p>
			
			<p>
				<strong>Export</strong> - export all codes into a csv file/JSON/XML for the current phenotype version.
				{% if user.is_authenticated and not CLL_READ_ONLY %}
					The button will be disabled unless you have permission to view <b>all</b> of the concepts used.
				{% endif %}
			</p>
			
			{% if user.is_authenticated and not CLL_READ_ONLY %}
				<p>
					<strong>Fork</strong> - This will take a copy of the historic phenotype version and create a new phenotype.
				</p>
				<p>
					<strong>Revert</strong> - This will restore the phenotype back to this version.
				</p>
				<p>
					<strong>Publish</strong> - This will publish the chosen version of the phenotype to the public.
						<br>Conditions to publish: 
						<ul>
							<li>The phenotype is not deleted.</li>
							<li>You must be the owner.</li>
							<li>The phenotype contains exportable codes.</li>
							<li>All concepts are published.</li>
						</ul>
				</p>
			{% endif %}
		</div>
	</div>
</div>
{% endblock container %}

{% block scripts %}
	<script src="{% static 'js/clinicalcode/component.js' %}"></script>
	<script src="{% static 'js/clinicalcode/concept.js' %}"></script>
	<script src="{% static 'js/clinicalcode/dataService.js' %}"></script>
	
	<script type="text/javascript">
		$('#codelisttab').click(function(e) {
			if($('#codelist-tab-div').attr("codelist_loaded") == "0"){
				// get the unique codes for the phenotype version
				phenotype_id = $('#phenotype_id_div').attr("phenotype_id");
				phenotype_history_id =$('#phenotype_history_id_div').attr("phenotype_history_id");
				
				//$(".loader").show();
				//$('#no-codes-td').addClass('spinner');				
				//$('#no-codes-td').html('<div class="loader" ></div>');
				
				dataService.getPhenotypeUniqueCodesByVersion(phenotype_id, phenotype_history_id, function(data){
						$('#codelist-tab-table tbody').html(data.html_uniquecodes_list);
						$('.codesAmount').text('Rows: ' + data.codes_count);
				});
				
				//$(".loader").hide();
				//$('#no-codes-td').removeClass('spinner');
				
				$('#codelist-tab-div').attr("codelist_loaded" , "1");
				
			}

		});
		
		

		$("#printBtn").click(function () {
			//window.print();
			printPage(printCallback);
		})

		function printPage(callback) {
			// before printing hide all unnecessary elements from webpage
			$('.btn').hide();
			$('#history-section').hide();
			$('#topButtons').hide();
			$('footer').hide();
			$('.popovers').hide();
			
			{% if user.is_authenticated %}
				$('#codelist-div-container').removeClass('pre-scrollable');
			{% endif%}
			
			window.print();

			// call printCallback function which shows back hidden elements
			callback();
		}

		function printCallback() {
			// when printing is finished or cancel show all hidden elements
			$('#history-section').show();
			$('#topButtons').show();
			$('footer').show();
			$('.btn').show();
			$('.popovers').show();
			
			{% if user.is_authenticated %}
				$('#codelist-div-container').addClass('pre-scrollable');
			{% endif%}

		}


	</script>


	<script type="text/javascript">
	
		//reconstruction of json data(concepts)
		$(document).ready(function(){
			var is_permitted_to_all = {{ is_permitted_to_all|lower }};
			var error_dic = {{ error_dic|safe }};
			//alert(is_permitted_to_all);
			//alert(error_dic);

			var are_concepts_latest_version = {{ are_concepts_latest_version|lower }};
			var version_alerts = {{ version_alerts|safe }};

			var concept_json = $('#concepts_json').val();
			concept_json = JSON.parse(concept_json);
			
			var concepts_id_name = $('#concepts_id_name').val();
			concepts_id_name = JSON.parse(concepts_id_name);

			$.each( concept_json, function( key, value ) {
	//			$.each( value, function( key, value ) {  // go thorugh concepts
				
				sts = '&nbsp;'
				pp = false;
				//alert(key+'...'+value);
				
				if (!is_permitted_to_all || !are_concepts_latest_version) {
					if (value['concept_id'] in error_dic || value['concept_id'] in version_alerts) {
						//alert(key+'');
						sts ='<div class="alert-danger" role="alert" style=" display:inline-block;" >'
						+'<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>'
						+'<span class="sr-only">Error:</span>';
						if (value['concept_id'] in error_dic) {
							sts += '-' + error_dic[value['concept_id']].join('<BR>').replace(/Child /ig, "");
							pp = true;
						}
						if (value['concept_id'] in version_alerts) {
							if(pp) {
								sts += '<BR>';
							}

							sts += '-' + version_alerts[value['concept_id']]; 	// .join('<BR>').replace(/Child /ig, "");
						}

						sts += '</div>';
					}
				}

				var c_url = '/concepts/'+value['concept_id']+'/version/'+value['concept_version_id']+'/detail/';

				$('#concept_table tbody>tr:last').after('<tr><td>' + sts + '</td>'
					+'<td>' + value['concept_id'] + '</td>'
					+'<td>' + value['concept_version_id'] + '</td>'
					+'<td>'
					+ '<a href='+c_url+'   title='+c_url+' target="_blank" class="alert-link">'
					+ get_Concept_name(concepts_id_name, value['concept_id'])
					+ '</a>'
					+ '</td></tr>'
				);

// 				$.each( value, function( key, value ) {  // go through concept data
// 					inHeaders = false;
// 					header_type = key.split("|");
// 					header = header_type[0];
// 					//type = header_type[1];

// 					headers = $('#concept_table thead>tr>th').each(function(index, input){
// 						if ($(input).text() == header) {
// 							inHeaders = true;
// 						}
// 					});

// 					if (!inHeaders) {
// 						$('#concept_table thead>tr>th:last').after('<th>' + header + '</th>');  //insert concept headers
// 					}

// 					$('#concept_table tbody>tr:last>td:last').after('<td>' + value + '</td>');  //isnert concept data
// 				});
			
	//		});
		
		});

			//-------------------------------------------------------------------------------
			function  get_Concept_name(list1, id){
			    var imgPath = ' <img src="{% static 'img/brands/' %}BRANDT1/logo.png" height="10px" title="BRANDT1" alt="BRANDT1" /> ';
				var conceptBrands = {{ conceptBrands|safe }};
				for (i in list1) {
					  if (list1[i]['id']==id) {
						  imgs = '';
						  for (b in conceptBrands[id]){
							  imgs += imgPath.replace(/BRANDT1/ig, conceptBrands[id][b] ) 
						  }
					    return(list1[i]['name'] + '' + imgs );
					    
					    
					  }
					}
				return('');
			}
		});		
	</script>
	
{% endblock scripts %}

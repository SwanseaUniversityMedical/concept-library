{% load static %}


<div class="form-group">

    <div class="col-sm-12">
        <div class="material-textfield" id="phenotypes-input-main">

            <input class="input-material col-sm-12 form-control" type="text" name="phenotypes"
                   id="phenotypes_1" placeholder="Search"
            >
            <input type="hidden" id="phenotypeshidden_1" name="phenotypeshidden_1"  class="hphenotypes">
            <label class="label-material">Phenotypes</label>
        </div>
    </div>
</div>


<div class="form-group">

    <div class="col-sm-12">
        <div class="material-textfield" id="concepts-input-main" style="display:none">

            <input class="input-material col-sm-12 form-control" type="text" name="concepts"
                   id="concepts_1" placeholder="Search"
            >
            <input type="hidden" id="concepthidden_1" name="concepthidden_1"  class="hconcepts">
            <label class="label-material">Concepts</label>
        </div>
    </div>
</div>


<hr/>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="{% static 'js/lib/jquery.autocomplete.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/clinicalcode/dataService.js' %}" type="text/javascript"></script>

<script type="text/javascript">
    const autoPhenotypes = () => {
        $("#phenotypes_1").on("focus", function (event) {
            var id = $(this).attr('id').split('_')[1];

            $(this).autocomplete({
                serviceUrl: "{% url 'api:phenotypes' %}",
                paramName: 'search',
                minlength:2,
                transformResult: function (response) {
                    // clear the selected field
                    //$('#concepthidden_' + id).val('');
                    return {
                        suggestions: $.map($.parseJSON(response), function (item) {

                            return {
                                data: String(item.id),
                                value: item.phenotype_id + "/" + item.version_id + " - " + "(" + (item.is_published ? 'published: ' : '') + ")" + " - " + item.phenotype_name + ", author: " + item.author
                            };
                        })
                    };
                },
                onSelect: function (suggestion) {
                    //event.preventDefault();
                    // set the id of the selected concept

                    $('#phenotypeshidden_' + id).val(suggestion.value);
                    console.log(suggestion);

                    $("#concepts-input-main").show()

                }
            })
        });
    }

    const autoConcepts = () => {
        $("#concepts_1").on("focus", function (event) {
            var id = $(this).attr('id').split('_')[1];
            var pk_id = document.getElementById('phenotypeshidden_1').value.substr(2,3)
            var history_id_raw = document.getElementById('phenotypeshidden_1').value
            var history_id = history_id_raw.substring(history_id_raw.indexOf('/'),history_id_raw.indexOf(' -')).trim().split('/')[1]
            var request =  "{% url 'api:api_phenotype_detail_version' phenotype_history_id=2 pk=1 %}".replace('PH1',"PH"+pk_id.toString()).replace('/2/','/'+history_id.toString()+'/')

            $(this).autocomplete({
                serviceUrl: request,

                transformResult: function (response) {
                console.log($.parseJSON(response)[0]['concepts'])

                    return {
                        suggestions: $.map($.parseJSON(response)[0]['concepts'], function (item) {

                            return {
                                data: String(item.id),
                                value: item.concept_id + "/" + item.concept_version_id + " - " + " - " + item.name
                            };
                        })
                    };
                },
                onSelect: function (suggestion) {
                    //event.preventDefault();
                    // set the id of the selected concept

                    $('#concepthidden_' + id).val(suggestion.value);
                    console.log(suggestion);


                }
            })
        });


    }
    autoPhenotypes();
    autoConcepts();

</script>

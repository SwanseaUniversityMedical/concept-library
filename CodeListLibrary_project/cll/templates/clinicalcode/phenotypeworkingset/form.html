{% extends "base.html" %}

{% load static %}

{% block title %}
    {% if form.instance.pk  is None %}
        New Working Set
    {% else %}
        Edit Working Set
    {% endif %}
{% endblock title %}

{% block crumbs %}
    <a class="nav-bar-title underline" href="{% url 'workingset_list' %}">Working Sets</a>
    > <strong>{{ form.instance.name|default_if_none:"" }}</strong>
{% endblock crumbs %}

{% block container %}



    {% if form.instance.pk is None %}
        <h2>Create a new working set</h2>
        <div class="row">
            <div class="col-md-12">
                <i class="help-block"><span class="required">*</span> denotes a required field</i>
                {% if form.errors %}
                    <div id="form-error" class="alert alert-danger  col-sm-12">
                        <p>The operation could not be performed because one or more error(s) occurred.<br/>
                            Please resubmit the form after making the following changes:</p>
                        <ul>
                            {% for field,error in form.errors.items %}
                                <li>{{ field }} - {{ error|striptags }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <h2>Edit working set</h2>
        <div class="row">
            <div class="col-md-12">
                <i class="help-block"><span class="required">*</span> denotes a required field</i>

            </div>
        </div>
    {% endif %}



    <link href="{% static 'css/phenotypeworkingset/form.css' %}" rel="stylesheet"/>

    <!-- This is used for the forking message. -->
    <div class="alert alert-success alert-dismissable" id="success-message" style="display: none;"
         role="alert"></div>
    <div class="alert alert-danger alert-dismissable" id="error-message" style="display: none;"
         role="alert"></div>


    <div class="panel panel-default">
        <div class="panel-body">

            <div class="row">
                <div class="col-md-12">
                    {% if form.pk is None %}
                        <form action="" method="post" class="form-horizontal" novalidate>

                    {% else %}
                        <form name='workingset-form' id='workingset-form' class="form-horizontal"
                              action="{% url "phenotypeworkingset_update" form.pk %}" method="POST" autocomplete="off">
                    {% endif %}
                    {% csrf_token %}
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="material-textfield">
                                {{ form.name }}
                                <label class="label-material required">{{ form.name.label }}</label>
                            </div>


                        </div>
                    </div>

                    <hr/>


                    {% if form.pk is not None %}
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label>Latest version ID</label>
                                <input type="hidden" id="latest_history_id" name="latest_history_id"
                                       value="{{ form.latest_history_id }}">
                                <input type="hidden" id="overrideVersion" name="overrideVersion"
                                       value="{{ overrideVersion|default_if_none:'0' }}">
                                {{ latest_history_id }}
                            </div>
                        </div>
                    {% endif %}
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="material-textfield">

                                <select class="input-material col-sm-12 form-control" name="type" id="type">
                                    {% for type in form.type %}
                                        {{ type }}
                                    {% endfor %}
                                </select>
                                <label class="label-material">Type</label>

                            </div>

                        </div>


                    </div>

                    <div class="form-group">

                        <div class="col-sm-11" id="concept-tag-form-container">

                            <div class="material-textfield">
                                <input class="input-material col-sm-12 form-control" type="text" id="txtTags"
                                       name="tagids" data-role="tagsinput">
                                <label class="label-material" for="txtTags">Tags</label>

                            </div>
                        </div>

                        <div class="col-sm-1 form-help-popover">
                            <a href="#" role="button" class="btn popovers" id="concept-tag-form" data-toggle="popover"
                               data-trigger="hover" data-container="#concept-tag-form-container" title=""
                               data-original-title="Tags" data-placement="left">
                                <i class="fa fa-question-circle" aria-hidden="true"></i>
                            </a>
                        </div>
                    </div>

                    <div class="form-group">

                        <div class="col-sm-11">
                            <div class="material-textfield">
                                {{ form.publication }}
                                <label class="label-material">{{ form.publication.label }}</label>
                            </div>
                        </div>
                        <div class="btn btn-default publication-button" id='addRow' style="padding: 5px 12px">
                            <i type='button' class="glyphicon glyphicon-plus"></i>
                        </div>

                    </div>
                    <div id="newRow"></div>


                    <div class="form-group">

                        <div class="col-sm-12">
                            <div class="material-textfield">


                                {{ form.citation_requirements }}

                                <label class="label-material">{{ form.citation_requirements.label }}</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="material-textfield">
                                <input class="input-material col-sm-12 form-control" type="text" name="datasources"
                                       id="datasources">
                                <label class="label-material">Data Sources</label>

                            </div>

                        </div>


                    </div>
                    <div class="form-group">

                        <div class="col-sm-12">
                            <div class="material-textfield">

                                <input class="input-material col-sm-12 form-control" type="text" name="collections"
                                       id="collections" data-role="tagsinput">
                                <label class="label-material" for="collections">Collections</label>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">

                        <div class="col-sm-12">
                            <div class="material-textfield">
                                {{ form.author }}
                                <label class="label-material required">{{ form.author.label }}</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">

                        <div class="col-sm-12">
                            <div class="material-textfield">
                                {{ form.description }}
                                <label class="label-material required">Description</label>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label class="col-sm-3" for="">Created by</label>
                        <div class="col-sm-12">
                            <p class="form-control-static">
                                {% if form.pk  is None %}
                                    {{ user.username }}
                                {% else %}
                                    {{ form.created_by.username }}
                                {% endif %}
                            </p>
                        </div>
                    </div>


                    {% if form.pk  is not None %}
                        <div class="form-group">
                            <div class="col-sm-12">
                                <label for="">Modified by</label>
                                <p class="form-control-static">{{ form.instance.modified_by.username }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <!-- ----------------------------------------------------------------------
                            PERMISSIONS
                         ----------------------------------------------------------------------
                     -->
                    <hr/>


                    <fieldset {% if not allowed_to_permit and form.pk  is not None %}disabled{% endif %}>
                        <!-- div class="form-group">
						<label class="col-sm-3" for="">Owned by:</label>
						<div class="col-sm-12">
							<p class="form-control-static">{{ form.owner.username}}</p>
						</div>
					</div-->

                        <!-- Allow the user to select a user from the list of known users. -->
                        <div class="form-group">

                            <div class="col-sm-11" id="workingset-owned-form-container">
                                <div class="material-textfield">
                                    {{ form.owner }}
                                    <label class="label-select required"
                                           for="{{ form.owner.id_for_label }}">{{ form.owner.label }}</label>
                                </div>
                            </div>
                            <div class="col-sm-1 form-help-popover">
                                <a href="#" role="button" class="btn popovers" id="workingset-owned-form"
                                   data-toggle="popover"
                                   data-trigger="hover" data-container="#workingset-owned-form-container" title=""
                                   data-original-title="Owned by:" data-placement="left">
                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                            <div id="popover-content-workingset-owned-form" class="hide popover-lg">
                                <p>This field defines the user who has permission to modify access to the concept.
                                    Please be aware that you will not be able to modify this if you give ownership to
                                    someone else and do not have editing permission.
                                </p>
                            </div>
                        </div>
                        <div class="form-group">

                            <div class="col-sm-11" id="workingset-group-form-container">
                                <div class="material-textfield">

                                    {{ form.group }}
                                    <label class="label-select"
                                           for="{{ form.group.id_for_label }}">{{ form.group.label }}</label>
                                </div>
                            </div>
                            <div class="col-sm-1 form-help-popover">
                                <a href="#" role="button" class="btn popovers" id="workingset-group-form"
                                   data-toggle="popover"
                                   data-trigger="hover" data-container="#workingset-group-form-container" title=""
                                   data-original-title="Permitted group:" data-placement="left">
                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                            <div id="popover-content-workingset-group-form" class="hide popover-lg">
                                <p>This field defines which group has permission to modify access to the concept if
                                    group
                                    permissions are selected. You can only select a group in which you are a member.
                                </p>
                            </div>
                        </div>

                        <div id="permissions" class="form-group">
                            <label class="col-sm-3">{{ form.owner_access.label }}</label>
                            <div class="col-sm-7">
                                <table>
                                    <tr>
                                        {% for choice in form.owner_access %}
                                            <td class="col-sm-2">
                                                <div class="radio">
                                                    <label>
                                                        {{ choice.tag }}
                                                        {{ choice.choice_label }}
                                                    </label>
                                                </div>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                </table>
                            </div>
                        </div>


                        <div id="permissions" class="form-group">
                            <label class="col-sm-3">{{ form.group_access.label }}</label>
                            <div class="col-sm-7">
                                <table>
                                    <tr>
                                        {% for choice in form.group_access %}
                                            <td class="col-sm-2">
                                                <div class="radio">
                                                    <label>
                                                        {{ choice.tag }}
                                                        {{ choice.choice_label }}
                                                        {% if choice.choice_label.strip == "View" or choice.choice_label.strip == "Edit" %}
                                                            {% if form.pk is not None %}
                                                                <span class="alert-warning"
                                                                      id="group_access_note"></span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </label>
                                                </div>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div id="permissions" class="form-group">
                            <label class="col-sm-3">Everyone else access:</label>
                            <div class="col-sm-7">
                                <table>
                                    <tr>
                                        {% for choice in form.world_access %}
                                            <td class="col-sm-2">
                                                <div class="radio">
                                                    <label>
                                                        {{ choice.tag }}
                                                        {{ choice.choice_label }}
                                                    </label>
                                                </div>
                                            </td>
                                        {% endfor %}
                                        <td class="col-sm-2">
                                            <div>&nbsp;</div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </fieldset>
                    <hr/>

                    <!-- ----------------------------------------------------------------------
                            Data LIST
                         ----------------------------------------------------------------------
                     -->


                    <div id=conceptsErrorsDiv style='display:none;'></div>

                    <div class="form-group">
                        <div class="col-sm-12">
                            <label>Phenotype/Concepts</label>
                            <table class="table display-table" id="attributes-table" style="width:100%;display:none">


                            </table>

                        </div>

                        <div class="row-form-flex row">
                            <button class="upload-button" id="add-data" type="button">
                                Upload
                            </button>


                        </div>


                        <hr/>

                    </div>


                    <div class="form-group">
                        <div class="col-sm-12">
                            <div class="row-form-flex row">

                                <div><br>
                                    <a href="{% url 'workingset_list' %}" class="btn">
                                        Return to list
                                    </a>
                                    <button class="btn btn-primary save-button" type="submit" id="save-changes">
                                        Save
                                    </button>

                                </div>

                            </div>
                        </div>

                    </div>


                    <input type="hidden" id="phenotypes_concepts_json" name="phenotypes_concepts_json">
                    <input type="hidden" id="workingset_data" name="workingset_data">
                    <input type="hidden" id="publication_data" name="publication_data">
                    <input type="hidden" id="previous_selection" name="previous_selection">



                    </form>

                    <!--	-------------------------------------------------------------------
                      Version History
                    -------------------------------------------------------------------	-->
                    {% if pk is not none %}
                        <div class="panel-body">
                            <div class="row">

                                <hr/>
                                <h3>Version History</h3>
                                <div class="pre-scrollable">
                                    <table class="table table-striped small-table table-hover">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Date</th>
                                            <!-- 							<th>Type</th> -->
                                            <th>Change reason</th>
                                            <th>User</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% include './partial_history_list.html' %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div id="popover-content-concept-tag-form" class="hide popover-lg">
                        <p>Tags are added within the administration section. Once a tag has been stored then you can
                            assign it here so that you can search this working set based on tag name(s). Simply start
                            typing the tag name you are looking for and it will appear within a dropdown just beneath
                            the textbox.</p>
                    </div>

                </div>
            </div>
        </div>
    </div>


{% endblock container %}

{% block scripts %}
    <script src="{% static 'js/clinicalcode/dataService.js' %}"></script>
    <script src="{% static 'js/clinicalcode/component.js' %}"></script>
    <script src="{% static 'js/clinicalcode/concept.js' %}"></script>
    <script src="{% static 'js/clinicalcode/tags.js' %}"></script>
    <script src="{% static 'js/clinicalcode/tagAutocomplete.js' %}"></script>

    <!------------------------ Selection Service dependencies -------------------------->
    <link href="{% static 'lib/daterangepicker/daterangepicker.css' %}" rel="stylesheet"/>
    <script src="{% static 'js/lib/daterangepicker/moment.min.js' %}"></script>
    <script src="{% static 'js/lib/daterangepicker/daterangepicker.js' %}"></script>
    <script src="{% static 'js/clinicalcode/filters/utils.js' %}"></script>
    <script src="{% static 'js/clinicalcode/filters/FuzzyQuery.js' %}"></script>
    <script src="{% static 'js/clinicalcode/filters/autocompleteSearch.js' %}"></script>
    <script src="{% static 'js/clinicalcode/workingset/selectionService.js' %}"></script>
    <!---------------------------------------------------------------------------------->




    <script type="text/javascript">
        // call the tag service initialize function in tags.js
        $("#author").tagsinput('items')
        tagAutocomplete('/api/v1/public/data-sources-list/', 'datasources', 'datasource_id', 'name').initialize()
        tagAutocomplete('/api/v1/public/collections/', 'collections', 'id', 'name').initialize()
        tagService.initialize();

        $(function () {
            {% for tag in tags %}
                $('#txtTags').tagsinput('add', {
                    'id': {{ tag.id }},
                    'description': '{{ tag.description }}',
                    'display': '{{ tag.get_display_display }}'
                });
            {% endfor %}
            {% for collection in collections %}
                $('#collections').tagsinput('add', {
                    'id': '{{ collection.id }}',
                    'name': '{{ collection.description }}'
                });
            {% endfor %}

            {% for datasource in datasources %}
                $('#datasources').tagsinput('add', {
                    'datasource_id': '{{ datasource.datasource_id }}',
                    'name': '{{ datasource.name }}'
                });

            {% endfor %}

            {% if publications %}
                let returnPub = {{publications|safe}}
                if (returnPub.length > 1) {
                    for (let j = 0; j < returnPub.length; j++) {
                        if (j === 0) {
                            $('#id_publication').val(returnPub[0])
                        } else {
                            addInput(returnPub[j], 'newRow')
                        }
                    }
                } else {
                    $('#id_publication').val(returnPub[0]);
                }

            {% endif %}

            {% if table_elements %}
                let dataset = {{table_elements|safe}}
                    $('#attributes-table').show()
                $('#add-data').hide()
                let table = createTable(0, dataset, 'attributes-table', [{data: 'Deletebut', title: ''},{data: 'Data', title: 'Data'}])
                let next_column_index = ((Object.keys(dataset[0]).length - 2) / 4)
                table = reDrawtable('attributes-table', next_column_index, false, dataset)

                table.buttons().container()
                    .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) '));
                $('#phenotypes_concepts_json').val(JSON.stringify(dataset)) // save value temporarly

            {% endif %}

            {% if workingset_data %}
                importTable({{ workingset_data|safe }})
                importSelection({{ workingset_data|safe }})
            {% endif %}




        });

        $("#addRow").click(function () {
                addInput('', 'newRow');
            }
        );
        $(document).on('click', '#removeRow', function () {
            $(this).closest('.form-group').remove();

        });


        /**
         * Adding input to html
         * @param value input value
         * @param id of the HTML element
         */
        const addInput = (value, id) => {
            var html = '';
            html += '<div class="form-group">';
            html += '<div class="col-sm-12">';
            html += '<div class="material-textfield input-group">';
            html += `<input type="text" name="publication" value ="${value}" class="input-material form-control" rows="1" placeholder="Add publication" maxlength="500" id="id_publication">`
            html += '<span class="input-group-btn">';
            html += '<button id="removeRow" style="padding:6px 12px;height: 35px" type="button" class="btn btn-danger">Remove</button>';
            html += '</span>'
            html += '</div>'
            html += '</div>';
            html += '</div>';

            $('#' + id).append(html);
        }

        /**
         * Collection all input values from all publication inputs
         * @returns {Array} data of all inputs t handle
         */
        const wrapPubinputs = () => {
            let input = document.querySelectorAll('*[id^="id_publication"]'); // Find inputs from appended html
            let data = []
            for (let i = 0; i < input.length; i++) {
                if (input[i].value !== "") {
                    data.push(input[i].value)
                }

            }
            return data

        }

        /*************************************
         *                                   *
         *            Selection logic        *
         *                                   *
         *************************************/
        var previous_selection = [];
        {% if previous_selection %}
            previous_selection = JSON.parse('{{ previous_selection |safe}}')

        {% endif %}
        $('#add-data').createSelection({
            // Props
            clearSelectedOnClose: false,
            clearSelectedOnImport: false,

            // Methods
            onImport: (service, selected) => {
                // Clicked the 'Import Concepts' button, and imported 'selected'
                var dataset = selected.map((element, index) => {
                    return {
                        "Deletebut": `<button class="btn btn-cl-danger ws-trash" type="button" onclick="deleteRow(this)" style="margin-top: 7px" id="ws-remove-row${index}"><i class="fa fa-trash ws-disabled-link" aria-hidden="true"></i></button>`,

                        "Data": `<div class="data-row" ><a href="/phenotypes/${element.phenotype.id}/version/${element.phenotype.version}/detail/" id="phenotype_url" target="_blank" rel="noopener noreferrer">${element.phenotype.id + '/' + element.phenotype.version}</a>` + '-' +
                            `<a href="/concepts/${element.concept.id}/version/${element.concept.version}/detail/"target="_blank" id="concept_url" rel="noopener noreferrer">${element.concept.id + '/' + element.concept.version + '-' + element.concept.name}</a></div>`
                    }

                })


                // Check if table exist to update table or create table
                if ($.fn.dataTable.isDataTable('#attributes-table')) {
                    let table = $('#attributes-table').DataTable();
                    table.rows().remove().draw()
                    let dataPrevious = $('#phenotypes_concepts_json').val() // restore old values
                    dataPrevious = JSON.parse(dataPrevious)

                    // Use first row as example to take columns but delete value
                    let newData = []
                    for (let i = 0; i < dataset.length; i++) {
                        let newObject = removalue(dataPrevious, i)
                        newData.push({
                            ...newObject,
                            ["Data"]: dataset[i].Data // Append new row
                        })

                    }

                    dataPrevious = mergeArrays(dataPrevious, newData) // Merge old values and new value to avoid duplicates
                    dataPrevious = refreshInputid(dataPrevious)


                    if (dataPrevious.length > 0) { // Check if user deletes data from pop-up or add
                        table.rows.add(dataPrevious).draw(); // draw row/rows
                        $('#phenotypes_concepts_json').val(JSON.stringify(dataPrevious)) // Saving as Json


                    } else {
                        $('#attributes-table').DataTable().destroy();
                        $('#attributes-table').empty();
                        $('#phenotypes_concepts_json').val('') // Clear table as user cleared the modal
                        $('#add-data').show()
                    }

                } else {
                    $('#attributes-table').show()
                    let table = createTable(0, dataset, 'attributes-table', [{
                        data: 'Deletebut',
                        title: ''
                    }, {data: 'Data', title: 'Concepts'}]) // Create table with initial data
                    table.buttons().container()
                        .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) ')); // Append buttons to the table


                    $('#phenotypes_concepts_json').val(JSON.stringify(dataset)) // save value temporarly
                    $('#add-data').hide()
                }


            },
            onClose: (service, selected) => {


            }
        }, previous_selection);


        /**
         * Merge two arrays of old Json with a new object
         * @param dataPrevious
         * @param newData
         * @returns {*[]}
         */
        const mergeArrays = (dataPrevious, newData) => {
            let newArr = []
            for (let j = 0; j < newData.length; j++) {
                for (let k = 0; k < dataPrevious.length; k++) {
                    if (newData[j].Data === dataPrevious[k].Data) {
                        newData.filter(function (el, i) {
                            return j !== i;
                        }); // remove data if new object has same data with previous one
                    }
                }
                newArr.push(newData[j]) // else append new data
            }

            for (let h = 0; h < newArr.length; h++) {
                for (let i = 0; i < dataPrevious.length; i++) {
                    if (newArr[h].Data === dataPrevious[i].Data) {
                        newArr[h] = Object.assign({}, newArr[h], dataPrevious[i]);
                        // After we add new data we can convert it to object to have same columns as previous
                    }
                }
            }


            return newArr
        }

        /**
         * Create table with columns or without
         * @param numbers - current column index
         * @param dataset - current JSON dataset to pass
         * @param id - HTML id element for table
         * @param columns - array of named columns
         * @returns {*|define.amd.jQuery}
         */
        const createTable = (numbers, dataset, id, columns) => {
            return $('#' + id).DataTable({
                    data: dataset,
                    columns: columns,
                    buttons: [
                        {
                            text: "Add column",
                            className: "table-button",
                            action: function (e, dt, node, config) {
                                addColumn(numbers)
                            },
                            attr: {
                                id: 'column-add'
                            }
                        },
                        {
                            text: "Add concept",
                            className: "table-button",
                            action: function (e, dt, node, config) {
                                $('#add-data').trigger('click')
                            },
                            attr: {
                                id: 'add-concept'
                            }
                        }
                    ],

                    fixedColumns: {
                        left: 2
                    },
                    scrollX: true, // allow to scroll horizontaly
                    scrollY: '70vh', // allow scroll vericaly for specific size 
                    scrollCollapse: true, // allow to table have overflow-x 
                    colReorder: true, // order the collumns
                    paging: false,
                    columnDefs: [{ // define which columns exclude for ordering
                        targets: [0],
                        orderable: false,
                        width: '5%'

                    }, { // define which columns exclude for ordering
                        targets: [1],
                        orderable: true,


                    }, {
                        targets: [''],
                        orderable: false

                    },
                    ],
                    order: [[1, 'asc']],

                }
            );
        }

        /**
         * Remove value from the first row to pass new element input to the new object input
         * @param dataPrevious
         * @returns new input with empty value
         */
        const removalue = (dataPrevious, length) => {


            let removeVal = Object.entries(dataPrevious[0])

            removeVal.forEach(element => {
                let parse = new DOMParser().parseFromString(element[1], "text/html")
                let input = parse.querySelector('*[id^="attribute-input"]');
                if (input !== null) {
                    input.setAttribute('value', '')
                    input.classList.remove('bg-danger')
                    input.id = input.id.slice(0, -1) + length
                    element[1] = $(input)[0].outerHTML
                }
                return element

            })

            return Object.fromEntries(removeVal)
        }

        const refreshInputid = (dataPrevious) => {
            for (let i = 0; i < dataPrevious.length; i++) {
                for (let [key, value] of Object.entries(dataPrevious[i])) {
                    let parse = new DOMParser().parseFromString(value, "text/html")
                    let input = parse.querySelector('*[id^="attribute-input-col"]');
                    let deleBut = parse.querySelector('*[id^="ws-remove-row"]')
                    if (input !== null) {
                        input.id = "attribute-input-col" + key.slice(-1) + 'row' + i
                        dataPrevious[i][key] = $(input)[0].outerHTML
                    }
                    if (deleBut !== null) {
                        deleBut.id = "ws-remove-row" + i
                        dataPrevious[i][key] = $(deleBut)[0].outerHTML
                    }
                }


            }
            return dataPrevious


        }


        /**
         * Return string type select value when wraping value or just input value when wrappinf
         * @param type html element from the array
         * @param id html id to find select value
         * @returns  select string type from select or input value
         */
        const returnValue = (type, id) => {
            let element = new DOMParser().parseFromString(type, "text/html")
            let select = element.querySelector(`*[id^="${id}"]`)
            if (id.startsWith("column_type")) {
                let val = select.value
                switch (parseInt(val)) {
                    case 0:
                        return false
                    case 1:
                        return 'INT'
                    case 2:
                        return 'FLOAT'
                    case 3:
                        return 'STRING'
                }
            } else {
                return select.value
            }


        }

        /**
         * Main functionality to add column dynamically
         * @param numbers - current column index
         */
        const addColumn = (numbers) => {
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            for (let i = 0; i < dataPrevious.length; i++) {


                dataPrevious[i] = { // for all row start initialize the object keys and values but taking into account old row
                    ...dataPrevious[i],
                    ["Attributes-row" + numbers]: `<input class="input-material" type="text"  style="width:100%" id="attribute-input-${'col' + numbers + 'row' + i}"/>`,
                    ["Attributes-select" + numbers]: `<select style="margin-right: 5px" class="input-material col-sm-12 form-control" onchange="selectHeader(this)" id="column_type${numbers}">'
						    +'<option  value="0" selected >Type</option>'
						    +'<option value="1">INT</option>'
						    +'<option value="2">FLOAT</option>'
						    +'<option value="3">STRING</option>'
						  +'</select>`,
                    ["Attributes-header" + numbers]: `<input class="input-material" type="text"   oninput="inputheader(this)" placeholder="Attribute name"  id="attribute-header${numbers}"/>`,
                    ["Attributes-delete" + numbers]: `<button class="btn btn-cl-danger ws-trash" id="ws-remove-column${numbers}"><i class="fa fa-trash ws-disabled-link" aria-hidden="true"></i></button>`

                }
            }
            let dataset = dataPrevious
            $('#phenotypes_concepts_json').val(JSON.stringify(dataset)) //saving the rows
            let table = reDrawtable('attributes-table', numbers, true, dataset)
            table.buttons().container()
                .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) '));


        }

        /**
         * Apply changes and redraw table
         * @param id of the existing table
         * @param numbers current column index
         * @param needColumn update column index if added column
         * @param dataset current dataset
         * @returns new table
         */
        const reDrawtable = (id, numbers, needColumn, dataset) => {
            let columns = [{data: "Deletebut", title: ""}, {data: "Data", title: "Concepts"}]// keep data column same
            let headers = Object.entries(dataset[0])
            for (let i = 0; i < headers.length - 1; i++) {
                if (headers[i][0].startsWith('Attributes-row')) {
                    columns.push({
                        data: headers[i][0],
                        title: `<div class='header-functions'><div class='header-functions-delete' style="display:flex">` + headers[i + 1][1] + headers[i + 3][1] + `</div>` + headers[i + 2][1] + `</div>`
                    })
                }
            }
            if (needColumn) {
                numbers++// add number index as we added column
            }

            if ($.fn.DataTable.isDataTable('#attributes-table')) {// if table exist we need to update by destroying old table and generate new table
                $('#' + id).DataTable().destroy();
                $('#' + id).empty();
                var table = createTable(numbers, dataset, 'attributes-table', columns)
                table.buttons().container()
                    .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) '));

                return table

            }

        }


        const inputheader = (element) => {
            let val = element.value
            let index = element.id.match(/\d+/)[0]
            if (/^[a-zA-Z0-9]+$/.test(val)) {
                element.setCustomValidity("")
                element.classList.remove('bg-danger')
                element.setAttribute('value', val)
            } else {
                element.setCustomValidity("Spaces and symbols are not allowed")
                element.classList.add('bg-danger')
                element.setAttribute('value', val)
                element.reportValidity()
            }
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            for (let i = 0; i < dataPrevious.length; i++) {
                dataPrevious[i]['Attributes-header' + (index)] = element.outerHTML
                $('#phenotypes_concepts_json').val(JSON.stringify(dataPrevious))
            }


        }

        const wrapData = () => {
            $('#publication_data').val(JSON.stringify(wrapPubinputs()).replace(/\[/g, '{').replace(/]/g, '}'))
            $('#previous_selection').val(JSON.stringify($('#add-data').data('SelectionService').selected))
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            let arrayOfData = []
            for (let i = 0; i < dataPrevious.length; i++) {
                let entry = Object.entries(dataPrevious[i])
                let mainData = wrapIds(dataPrevious[i]['Data'])
                if (entry.length > 1) {
                    mainData['Attributes'] = []
                    for (let j = 0; j < (entry.length - 2) / 4; j++) {
                        let type = dataPrevious[i]['Attributes-select' + j]
                        let attribute_name = dataPrevious[i]['Attributes-header' + j]
                        let attribute_value = dataPrevious[i]['Attributes-row' + j]
                        mainData['Attributes'].push({
                            name: returnValue(attribute_name, 'attribute-header' + j),
                            type: returnValue(type, 'column_type' + j),
                            value: returnValue(attribute_value, 'attribute-input-col' + j)
                        })


                    }
                    arrayOfData.push(mainData)
                } else {
                    arrayOfData.push(mainData)
                }
            }


            $('#workingset_data').val(JSON.stringify(arrayOfData))
            return true


        }

        $('#save-changes').on('click', function (e) {
            if (!$('#phenotypes_concepts_json').val()) {
                return;
            }
            if (!finalValidation($('#phenotypes_concepts_json').val())) {
                e.preventDefault();
            } else {
                wrapData()
            }


        })

        const finalValidation = (dataPrevious) => {
            let conds = []
            dataPrevious = JSON.parse(dataPrevious)
            for (let i = 0; i < dataPrevious.length; i++) {
                let entry = Object.entries(dataPrevious[i])
                for (let j = 0; j < (entry.length - 2) / 4; j++) {
                    let select = dataPrevious[i]['Attributes-select' + j]
                    let header = dataPrevious[i]['Attributes-header' + j]
                    let input = dataPrevious[i]['Attributes-row' + j]
                    input = new DOMParser().parseFromString(input, "text/html")
                    select = new DOMParser().parseFromString(select, "text/html")
                    header = new DOMParser().parseFromString(header, "text/html")
                    input = input.querySelector('*[id^="attribute-input"]')
                    select = select.querySelector('*[id^="column_type"]')
                    header = header.querySelector('*[id^="attribute-header"]')
                    let header_cond = /^[a-zA-Z0-9]+$/.test(header.value)
                    if (!header_cond) {
                        {
                            header.value === '' ?
                                $('#' + header.id)[0].setCustomValidity("Empty attribute is not allowed") : $('#' + header.id)[0].setCustomValidity("Spaces and symbols are not allowed")
                        }
                        $('#' + header.id)[0].classList.add('bg-danger')
                        $('#' + header.id)[0].reportValidity()
                    }
                    conds.push(regexCheck(select.value, $('#' + input.id), $('#' + input.id).val(), false, false, false) && header_cond)
                }
            }
            return !conds.includes(false);

        }

        const importTable = (data) => {
            let phenotype_concepts_json = [];
            let allData;
            for (let i = 0; i < data.length; i++) {
                allData = {
                     "Deletebut": `<button class="btn btn-cl-danger ws-trash" type="button" onclick="deleteRow(this)" style="margin-top: 7px" id="ws-remove-row${i}"><i class="fa fa-trash ws-disabled-link" aria-hidden="true"></i></button>`,

                    "Data": `<div class="data-row" ><a href="/phenotypes/${data[i].phenotype_id}/version/${data[i].phenotype_version_id}/detail/" id="phenotype_url" target="_blank" rel="noopener noreferrer">${data[i].phenotype_id + '/' + data[i].phenotype_version_id}</a>` + '-' +
                        `<a href="/concepts/${data[i].concept_id}/version/${data[i].concept_version_id}/detail/"target="_blank" id="concept_url" rel="noopener noreferrer">${data[i].concept_id + '/' + data[i].concept_version_id + '-' + data[i].concept_name}</a>` +`</div>`
                }

                if (data[i].Attributes !== undefined) {
                    let attributes = {};
                    for (let j = 0; j < data[i].Attributes.length; j++) {
                        attributes = {
                            ...attributes,
                            ["Attributes-row" + j]: `<input class="input-material" type="text" value="${data[i].Attributes[j].value}" style="width:100%" id="attribute-input-${'col' + j + 'row' + i}"/>`,
                            ["Attributes-select" + j]: `<select style="margin-right: 5px" class="input-material col-sm-12 form-control" onchange="selectHeader(this)" id="column_type${j}">'
						    + '<option  value="0">Type</option>'
						    +'<option value="1" ${data[i].Attributes[j].type === 'INT' ? 'selected' : ''}>INT</option>'
						    +'<option value="2" ${data[i].Attributes[j].type === 'FLOAT' ? 'selected' : ''}>FLOAT</option>'
						    +'<option value="3" ${data[i].Attributes[j].type === 'STRING' ? 'selected' : ''}>STRING</option>'
						  +'</select>`,
                            ['Attributes-header' + j]: `<input class="input-material" type="text"  value="${data[i].Attributes[j].name}" oninput="inputheader(this)" placeholder="Attribute name"  id="attribute-header${j}"/>`,
                            ["Attributes-delete" + j]: `<button class="btn btn-cl-danger ws-trash" id="ws-remove-column${j}"><i class="fa fa-trash ws-disabled-link" aria-hidden="true"></i></button>`


                        }

                    }
                    phenotype_concepts_json.push({...allData, ...attributes})

                } else {
                    phenotype_concepts_json.push(allData)
                }

            }
            let dataset = phenotype_concepts_json
            $('#attributes-table').show()
            $('#add-data').hide()
            let table = createTable(0, dataset, 'attributes-table', [{data: 'Deletebut', title: ''}, {
                data: 'Data',
                title: 'Data'
            }])
            let next_column_index = ((Object.keys(dataset[1]).length - 2) / 4)


            table = reDrawtable('attributes-table', next_column_index, false, dataset)
            table.buttons().container()
                .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) '));

            $('#phenotypes_concepts_json').val(JSON.stringify(dataset)) // save value temporarly


        }

        const importSelection = (array) => {
            let arraySelection = []
            for (let i = 0; i < array.length; i++) {
                arraySelection.push({
                    'concept': {
                        'coding': array[i].concept_coding,
                        'id': array[i].concept_id,
                        'version': array[i].concept_version_id,
                        'name': array[i].concept_name
                    },
                    'phenotype': {
                        'id': array[i].phenotype_id,
                        'name': array[i].phenotype_name,
                        'version': array[i].phenotype_version_id,

                    }
                })
            }
            $('#add-data').data('SelectionService').selected = arraySelection

        }


        const wrapIds = (dataIds) => {
            let element = new DOMParser().parseFromString(dataIds, "text/html")
            element = element.links
            dataIds = element[0].innerText + '-' + element[1].innerText
            let phenotype = dataIds.substring(dataIds.indexOf('PH'), dataIds.indexOf('-C'))
            let phenotype_id = phenotype.split('/')[0]
            let phenotype_version = phenotype.split('/')[1]

            let concept = dataIds.substring(dataIds.indexOf('-C'), dataIds.indexOf(' - '))
            let concept_id = concept.split('/')[0].slice(1)
            let concept_version = concept.split('/')[1].substring(0, concept.indexOf('-', 5)).replace(/\D/g, '')

            return {
                phenotype_id: phenotype_id,
                phenotype_version_id: parseInt(phenotype_version),
                concept_id: concept_id,
                concept_version_id: parseInt(concept_version)
            }

        }


        const selectHeader = (element) => {
            var table = $('#attributes-table').DataTable()
            var oldScrollX = $('#attributes-table').position().left
            var oldScrollY = $('#attributes-table').position().top
            let val = element.value
            let index = element.id.match(/\d+/)[0]
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            let updatedSelect = changeSelectValue(val, index)

            for (let i = 0; i < dataPrevious.length; i++) {
                dataPrevious[i]['Attributes-select' + (index)] = `${updatedSelect}`
                dataPrevious[i]['Attributes-row' + (index)] = highlightinput(dataPrevious[i]['Attributes-row' + (index)], updatedSelect)
                $('#phenotypes_concepts_json').val(JSON.stringify(dataPrevious))
            }

            let dataPrevious2 = $('#phenotypes_concepts_json').val()
            dataPrevious2 = JSON.parse(dataPrevious2)
            table = reDrawtable('attributes-table', table.columns().header().length - 1, false, dataPrevious2)
            table.buttons().container()
                .appendTo($('#attributes-table_wrapper .col-sm-6:eq(0) '));

            $('div.dataTables_scrollBody')[0].scrollLeft = oldScrollX * -1
            $('div.dataTables_scrollBody')[0].scrollTop = oldScrollY * -1


        }


        const changeSelectValue = (val, index) => {
            let element = `<select style="margin-right: 5px" class="input-material col-sm-12 form-control" onchange="selectHeader(this)" id="column_type${index}">'
						    +'<option value="0">Type</option>'
						    +'<option value="1">INT</option>'
						    +'<option value="2">FLOAT</option>'
						    +'<option value="3">STRING</option>'
						  +'</select>`
            let parse = new DOMParser().parseFromString(element, "text/html")
            let select = parse.querySelector('*[id^="column_type"]')
            select.options[val].defaultSelected = true


            return $(select)[0].outerHTML

        }

        const deleteRow = (element) => {

            let table = $('#attributes-table').DataTable()
            let phenotype_concepts_json = JSON.parse($('#phenotypes_concepts_json').val())
            let index = element.id.match(/\d+/)[0]
            let selection = $('#add-data').data('SelectionService').selected
            if (confirm("Remove this concept?")) {
                let tr = $(element).closest('tr')
                table.row(tr).remove().draw(false);
                if (table.rows().count() !== 0) {
                    let toDel = phenotype_concepts_json[parseInt(index)]
                    let filtered = phenotype_concepts_json.filter(function (el) {
                        return el !== toDel;
                    });

                    $('#phenotypes_concepts_json').val(JSON.stringify(filtered))
                    $('#add-data').data('SelectionService').selected = selection.filter(function (el) {
                        return el !== $('#add-data').data('SelectionService').selected[parseInt(index)];
                    });
                } else {
                    $('#add-data').data('SelectionService').selected = []
                    $('#attributes-table').DataTable().destroy();
                    $('#attributes-table').empty();
                    $('#phenotypes_concepts_json').val('') // Clear table as user cleared the modal
                    $('#add-data').show()
                }


            }


        }


        function highlightinput(input, select) {
            input = new DOMParser().parseFromString(input, "text/html")
            select = new DOMParser().parseFromString(select, "text/html")
            input = input.querySelector('*[id^="attribute-input"]')
            select = select.querySelector('*[id^="column_type"]')

            if (input !== null) {
                if (input.value !== '') {
                    input.classList.add('bg-danger')
                    let custom = '<div>'
                    custom += input.outerHTML
                    if (select.value === "0") {
                        custom += `<span class='text-danger'>Choose type attribute</span>`
                    } else {
                        custom += `<span class='text-danger'>Type changed to ${select.options[select.value].text}</span>`
                    }

                    custom += '</div>'
                    return custom
                } else {
                    return input.outerHTML
                }

            }


        }


        $('#attributes-table').on('input', 'td', function (e) {
            let table = $('#attributes-table').DataTable()
            let cell = table.cell(this).index()
            let input = $(table.cell(this).node()).find('input')
            input.removeClass('bg-danger')
            $(table.cell(this).node()).find('span').remove()
            let value = input.val()
            let rowIdx = cell.row
            let colindex = cell.column
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            dataPrevious[rowIdx]['Attributes-row' + (colindex - 1)] = checkTypeinput(input, value, rowIdx, colindex)[0].outerHTML
            $('#phenotypes_concepts_json').val(JSON.stringify(dataPrevious))


        });

        var mx;

        $("#attributes-table").on({

            mousemove: function (e) {
                var $scroller = $(".dataTables_scrollBody");
                var mx2 = e.pageX - $scroller[0].offsetLeft;
                if (mx) $scroller[0].scrollLeft = this.sx + mx - mx2;
            },
            mousedown: function (e) {
                var $scroller = $(".dataTables_scrollBody");
                this.sx = $scroller[0].scrollLeft;
                mx = e.pageX - $scroller[0].offsetLeft;
            }
        });

        $("#attributes-table").on("mouseup", function () {
            mx = 0;
        });


        const checkTypeinput = (input, val, rowIndex, columnIndex) => {
            let dataPrevious = $('#phenotypes_concepts_json').val()
            dataPrevious = JSON.parse(dataPrevious)
            let type = dataPrevious[rowIndex]['Attributes-select' + (columnIndex - 1)]
            let element = new DOMParser().parseFromString(type, "text/html")
            let select = element.querySelector('*[id^="column_type"]')
            let select_val = select.value
            return regexCheck(select_val, input, val, false, true, true)


        }
        const regexCheck = (select_val, input, val, trim, returninput, changeinp) => {

            switch (parseInt(select_val)) {
                case 0:
                    input.addClass('bg-danger')
                    input.val($.trim(input.val()).slice(0, -1));
                    input[0].setCustomValidity("Choose type attribute")
                    input[0].reportValidity()
                    return returninput ? input : false

                case 1:
                    if (/(^[0-9]+$|^$|^\s$)/.test(val)) {
                        {
                            changeinp ? input.attr('value', val) : false
                        }
                        input[0].setCustomValidity("");
                        return returninput ? input : true
                    } else {
                        input.addClass('bg-danger')
                        {
                            changeinp ? input.attr('value', val) : false
                        }
                        input[0].setCustomValidity("Only integers")
                        input[0].reportValidity()
                        {
                            trim ? input.val(input.val().slice(0, -1)) : false
                        }
                        return returninput ? input : false
                    }
                case 2:
                    if (/^([-])([0-9]{1,})?(\.)?([0-9]{1,})?$|^([0-9]{1,})?(\.)?([0-9]{1,})?$/.test(val)) {
                        input[0].setCustomValidity("");
                        {
                            changeinp ? input.attr('value', val) : false
                        }
                        return returninput ? input : true
                    } else {
                        input.addClass('bg-danger')
                        {
                            changeinp ? input.attr('value', val) : false
                        }
                        input[0].setCustomValidity("Only float numbers")
                        input[0].reportValidity()
                        {
                            trim ? input.val(input.val().slice(0, -1)) : false
                        }
                        return returninput ? input : false
                    }
                case 3: {
                    changeinp ? input.attr('value', val) : false
                }
                    return returninput ? input : true

            }
        }


    </script>



{% endblock scripts %}


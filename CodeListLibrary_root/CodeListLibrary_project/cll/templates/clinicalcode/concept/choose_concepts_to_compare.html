{% extends "base.html" %}

{% load staticfiles %}

{% block title %}| Compare concept{% endblock title %}

{% block container %}

<form method="post" id="compareForm" name="compareForm"   action="" class="form-horizontal js-submit-form" novalidate>
	{% csrf_token %}
	
<h2 >
	<i class="fa fa-columns" aria-hidden="true"></i><i> Choose 2 concepts to compare</i>
</h2>
<i class="help-block" style="font-size: 12px;">Start typing a concept name to see search result</i>


<div class="panel panel-default">
	<div class="panel-body">
		<div class="row">
			<div class="col-md-12">
				<div class="form-horizontal">
				
				
									
<table class="table" style="margin-bottom: 0px;">
	<thead>
		<tr>
			<th colspan=2><h4>Concept #1</h4></th>
			<th >&nbsp;</th>
			<th colspan=2><h4>Concept #2</h4></th>
		</tr> 
	</thead>	
	
	<tbody>
	
		<tr>
			<td colspan=2 >
				<div  id="concept-search-container1">
					<input class="form-control" type="text" placeholder="Search1" name="search1" indx="1" id="concept-search-text1" value="">
				</div>				
			</td>
			<td >&nbsp;</td>
			<td colspan=2>
				<div  id="concept-search-container2">
					<input class="form-control" type="text" placeholder="Search2" name="search2" indx="2" id="concept-search-text2" value="">
				</div>		
			</td>
		</tr>
		
		<tr>
			<td colspan=5>
				&nbsp;
			</td>
		</tr> 
				
		
		<tr>
			<td colspan=2>
				<h4><i class="fa fa-history" aria-hidden="true"></i> Versions</h4>
			</td>
			<td >&nbsp;</td>
			<td colspan=2>
				<h4><i class="fa fa-history" aria-hidden="true"></i> Versions</h4>
			</td>
		</tr> 

		
		<tr>
			<td colspan=2 id="concept-versions-1">
            	&nbsp;no versions
            </td>
			<td >&nbsp;</td>
			<td colspan=2 id="concept-versions-2">
				&nbsp;no versions
			</td>
		</tr> 

	</tbody>
</table>
						
						
																	
				</div>
			</div>
		</div>		
	</div>
</div>

<div>	
 	<input type="hidden" id="id_concept_ref1" name="id_concept_ref1"  value="">
 	<input type="hidden" id="id_concept_ref2" name="id_concept_ref2"  value=""> 	 
</div>


<div  style="text-align:center">
	<a href="" 
	   class="btn btn-info" target="_blank"
	   id="compare" >
		<i class="fa fa-columns" aria-hidden="true"></i> Compare codes of the two versions
	</a>   	
</div>	

</form>
{% endblock container %}

{% block scripts %}
		
<script src="/static/js/clinicalcode/dataService.js"></script>

<script  type="text/javascript"> 
$(function(){
	 //------------------------------------------------
		// autocomplete for finding a concept, enter concept name and it will display a list of possible matches
		$('#concept-search-text1,#concept-search-text2').autocomplete({			
			serviceUrl: '/api/concepts/?id=0',
			paramName: 'search',
			transformResult: function(response){
				// clear the selected field
				$('#id_concept_ref'+$(this).attr("indx")).val('');
				$('#concept-versions-'+$(this).attr("indx")).html('&nbsp;');
				
				return {
					suggestions: $.map($.parseJSON(response), function(item){
						return {data: String(item.id), value: "Concept: " + item.id + " - " + item.name + ", author: " + item.author};
					})
				};
			},
			onSelect : function(suggestion){
				// set the id of the selected concept
				//alert($('#id_concept_ref'+$(this).attr("indx")).val());
				$('#id_concept_ref'+$(this).attr("indx")).val(suggestion.data);
				
				//$('#compareForm #id_name').val(suggestion.value.split(', author: ')[0].split(' - ').slice(1).join(' - '));
				//$('#div_id_name').removeClass('has-error');
		        //$('#help_id_name').html('');
		        		     
				// get the historical versions of the concept
				dataService.getConceptVersions(suggestion.data, $(this).attr("indx"), function(data){
					if(data.form_is_valid){
						//alert(data.html_versions_list);
						//alert('data.indx='+data.indx);
						//alert($('#concept-versions-'+data.indx).html());
						$('#concept-versions-'+data.indx).html(data.html_versions_list);
						//$('#concept-versions-1').html(data.html_versions_list);
						//alert($('#concept-versions-'+data.indx).html());
					}
				});
			}
		}).on('blur', function(event){
			if($(this).val() == ""){
				$('#id_concept_ref'+$(this).attr("indx")).val('');
				$('#concept-versions-'+$(this).attr("indx")).html('&nbsp;');

				//$('#xx').val(	$(this).attr("indx") ); 
			}
		});
		//------------------------------------------------
		//================================================
			
			$("#compare").click(function (event) {
			event.preventDefault();
			
			c1 = $('#id_concept_ref1').val();
			 
			if(c1 == ''){
		            alert("You have to search and select Concept #1");
		            return false;
		        }
			 			
			c2 = $('#id_concept_ref2').val();
			if(c2 == ''){
	            alert("You have to search and select Concept #2");
	            return false;
	        }
		 		
			//alert('c1='+c1+'   ...  c2='+c2);
			
			 if(! $("#ver-sel-1").length){
		            alert("You have to choose a version for Concept #1");
		            return false;
		        }
			 
			 if(! $("#ver-sel-2").length){
		            alert("You have to choose a version for Concept #2");
		            return false;
		        }
			 
			v1 = $('#ver-sel-1').children("option:selected").val();
			v2 = $('#ver-sel-2').children("option:selected").val();
			//alert('v1='+v1+'   ...  v2='+v2);
			
			if(c1 == c2 && v1 == v2){
	            alert("You cannot compare the same concept with the same version. \n choose different versions");
	            return false;
	        }
		 	
			//..................
			var form = $(this).closest("form");
		    //alert($(this).closest("form").attr('action'));
		    //alert(form.attr('action')); with
		    
		    href = "/concepts/"+c1+"/"+v1+"/compare/"+c2+"/"+v2+"/";
			form.attr('action' , href);
			
			//alert(form.attr('action'));
			
			form.submit();	
			return false;
			
		
		});
		
		//------------------------------------------------
	});

	//------------------------------------------------
	$(document).on("keypress", ":input:not(textarea):not([type=submit])", function(event) {
		return event.keyCode != 13;
	});
	
</script>

{% endblock scripts %}

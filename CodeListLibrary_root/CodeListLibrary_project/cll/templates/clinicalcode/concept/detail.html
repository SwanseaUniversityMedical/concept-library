{% extends "base.html" %}

{% load staticfiles %}

{% block title %}| View Concept{% endblock title %}

{% block container %}

<h2><i class="fa fa-file-o" aria-hidden="true"></i> {{ object.name }}
	{% for item in request.BRAND_GROUPS %}
		{% for brand, groups in item.iteritems %}
			{% if object.group.name in groups %}
			<img style="margin-top:-5px;" src="{% static 'img/brands/' %}{{brand}}/logo.png" height="30px" title="{{brand}}" alt="{{brand}}" />
			{% endif %}
		{% endfor %}
	{% endfor %}
</h2>

<div class="panel panel-default">
	<div class="panel-body">
			<div class="col-sm-11" id="concept-form-container">
				<i class="help-block"></i>
			</div>
		<div class="row">
			<div class="col-sm-1 text-right">
				<a href="#" role="button" class="popovers" id="concept-form" data-container="#concept-form-container" data-toggle="popover"
					data-trigger="hover" title="" data-original-title="Concept overview" data-placement="left">
					<i class="fa fa-question-circle" aria-hidden="true"></i>
				</a>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div class="form-horizontal">
					<!--
					<div class="form-group  highlight-row">
						<label class="col-sm-4">Name:</label>
						<div class="col-sm-7">
							{{ object.name }}							
						</div>
					</div>
					 -->
					<div class="row" id="concept-button-list-container">
						<div class="col-sm-12">
							<a href="{% url 'concept_list' %}" class="btn btn-success">
								<i class="fa fa-reply" aria-hidden="true"></i> Return to list
							</a>
						{% if object.id %}						
							<div class="dropdown btn-group" > 
							  <button {% if not user_can_export %} disabled title="Component concept(s) deleted or revoked access!!" {% endif %} type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="export-btn">
							    Export
							    <span class="caret"></span>
							  </button>
							  <ul class="dropdown-menu">
							  <li>
							    <a {% if user_can_export %} href="{% url 'concept_codes_to_csv' pk=object.id %}" {% endif %} 
							       class="dropdown-item" >
									<i class="fa fa-file-excel-o" aria-hidden="true"></i> CSV
								</a>
							   </li>
							   <li>
								<a {% if user_can_export %} href="/api/export_concept_codes/{{ object.id }}/?format=json" target=_blank {% endif %} 
							       class="dropdown-item" >
									<i class="fa fa-file-text" aria-hidden="true"></i> JSON
								</a>
							   </li>
							   <li>
								<a {% if user_can_export %} href="/api/export_concept_codes/{{ object.id }}/?format=xml" target=_blank {% endif %} 
							       class="dropdown-item" >
									<i class="fa fa-file-code-o" aria-hidden="true"></i> XML
								</a>
							   </li>
							  </ul>
							</div>					
							
							{% if not CLL_READ_ONLY %}
								<a {% if allowed_to_create %} class="js-load-modal btn btn-primary" href="{% url 'concept_fork' pk=object.id %}"
								   {% else %} class="btn btn-primary" disabled
								   {% endif %} id="fork-btn">
									<i class="fa fa-code-fork" aria-hidden="true"></i> Fork
								</a>
							{% endif %}
							
							{% if enable_publish and not CLL_READ_ONLY %}
							<a 
								{% if not object.is_deleted %} class="js-load-modal btn btn-primary" href="{% url 'concept_publish' pk=object.id concept_history_id=history.0.history_id %}" 
								{% else %} class="btn btn-primary" disabled  title="Deleted concepts cannot be published !!" 
								{% endif %} 
								 id="publish2" >
								<i class="fa fa-paper-plane" aria-hidden="true"></i> Publish 
							</a>
							{% endif %}
							
							<!-- Tree not currently working.
							<a class="js-load-modal btn btn-info" href="{% url 'concept_tree' object.id %}">
								<i class="fa fa-tree" aria-hidden="true"></i> View Tree
							</a>
							  -->
						{% endif %}
							<a href="#" role="button" class="btn popovers" id="concept-button-list" data-toggle="popover"
							   data-trigger="hover" data-container="#concept-button-list-container" title="" 
							   data-original-title="" data-placement="right">
								<i class="fa fa-question-circle" aria-hidden="true"></i>
							</a>
						</div>
					</div>
					<div class="alert alert-success alert-dismissable" id="success-message" style="display: none;" role="alert"></div>
					<div class="alert alert-danger alert-dismissable" id="error-message" style="display: none;" role="alert"></div>
					
					<hr/>			

 					<div class="form-group">
						<label class="col-sm-4">ID:</label>
						<div class="col-sm-7">
							{{ object.id }}						
						</div>
					</div>
 					<div class="form-group highlight-row">
						<label class="col-sm-4">Latest history ID:</label>
						<div class="col-sm-7">
							{{ history.0.history_id }}						
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4">Tags:</label>
						<div class="col-sm-7">
							{% for tag in tags %}
								<div>{{ tag.tag.description }}</div>
							{% endfor %}						
						</div>
					</div>
																		

					<div class="form-group highlight-row">
						<label class="col-sm-4">Author:</label>
						<div class="col-sm-7">
							{{ object.author }}							
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4">Entry date:</label>
						<div class="col-sm-7">
							{{ object.entry_date }}							
						</div>
					</div>

					
					<div class="form-group highlight-row">
						<label class="col-sm-4">Description:</label>
						<div class="col-sm-7">
							{{ object.description }}							
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4">Coding system:</label>
						<div class="col-sm-7">
							{{ object.coding_system }}
						</div>
					</div>
					<div class="form-group highlight-row">
						<label class="col-sm-4">Created by:</label>
						<div class="col-sm-7">
							<p class="form-control-static">{{ object.created_by.username }}</p>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4">Modified by:</label>
						<div class="col-sm-7">
							<p class="form-control-static">{{ object.modified_by.username}}</p>
						</div>
					</div>
					<div class="form-group highlight-row">
						<label class="col-sm-4">Validation performed:</label>
						<div class="col-sm-7">
							<input type="checkbox" {% if object.validation_performed %}checked="checked"{% endif %} disabled />
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4">Validation description:</label>
						<div class="col-sm-7">
							{{ object.validation_description }}									
						</div>
					</div>
					
					<div class="form-group highlight-row">
						<label class="col-sm-4">Primary publication DOI:</label>
						<div class="col-sm-7">
							{{ object.publication_doi }}								
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4">Primary publication link:</label>
						<div class="col-sm-7">
							{{ object.publication_link }}
						</div>
					</div>

					<div class="form-group">
						<label class="col-sm-4">Secondary  publication link:</label>
						<div class="col-sm-7">
							{{ object.secondary_publication_links }}
						</div>
					</div>					
					
					<div class="form-group highlight-row">
						<label class="col-sm-4">Paper published:</label>
						<div class="col-sm-7">
							<input type="checkbox" {% if object.paper_published %}checked="checked"{% endif %} disabled />
						</div>
					</div>
					
					<div class="form-group">
						<label class="col-sm-4">Source reference:</label>
						<div class="col-sm-7">
							{{ object.source_reference }}
						</div>
					</div>
					
					<div class="form-group highlight-row">
						<label class="col-sm-4">Citation requirements:</label>
						<div class="col-sm-7">
							{{ object.citation_requirements }}
						</div>
					</div>
					
					<hr />
					<div class="form-group">
						<label class="col-sm-4">Owner:</label>
						<div class="col-sm-7">
							<p class="form-control-static">{{ object.owner.username }}</p>
						</div>
					</div>
					<div id="permissions" class="form-group highlight-row"">
						<label class="col-sm-4">Owner access:</label>
						<div class="col-sm-7">								
							{% if object.owner_access == 1 %}	
								<span>None</span>
							{% elif object.owner_access == 2 %}
								<span>View only</span>
							{% elif object.owner_access == 3 %}
								<span>View and edit</span>
							{% else %}
								
							{% endif %}
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4">Group:</label>
						<div class="col-sm-7">
							<p class="form-control-static">{{ object.group }}</p>
						</div>
					</div>
					<div id="permissions" class="form-group highlight-row">
						<label class="col-sm-4">Group access:</label>
						<div class="col-sm-7">
							{% if object.group_access == 1 %}	
								<span>No access</span>
							{% elif object.group_access == 2 %}
								<span>View only</span>
							{% elif object.group_access == 3 %}
								<span>View and edit</span>
							{% else %}
								
							{% endif %}
						</div>
					</div>
					<div id="permissions" class="form-group">
						<label class="col-sm-4">Everyone else access:</label>
						<div class="col-sm-7">
							{% if object.world_access == 1 %}	
								<span>No access</span>
							{% elif object.world_access == 2 %}
								<span>View only</span>
							{% elif object.world_access == 3 %}
								<span>View and edit</span>
							{% else %}
								
							{% endif %}
						</div>
					</div>
				
				{% if not CLL_READ_ONLY %}
					<div class="form-group">
						<div class="col-xs-offset-3 col-xs-9">
							<a {% if user_can_edit %}href="{% url 'concept_update' object.id %}"{% endif %} class="btn btn-primary"
								{% if not user_can_edit %} disabled {% endif %} >
								<i class="fa fa-edit" aria-hidden="true"></i> Edit concept
							</a>
						</div>						 
					</div>
				{% endif %} 	
	<!--	-------------------------------------------------------------------
				CONCEPT COMPONENT TABLE
			-------------------------------------------------------------------
	  -->		
					<hr />
					<div class="w-50 p-3 bs-example" style="width:50%;">
					    <div class="alert-info fade in" style="height:20px;">
					       	Chosen concept components will refer to the latest version.
					    </div>
					</div>
					
					<div class="col-sm-11" id="concept-component-form-container">
						<h3><i class="fa fa-cogs" aria-hidden="true"></i> Components</h3>
					</div>	
					<div class="col-sm-1 text-right">
						<a href="#" role="button" class="popovers" id="concept-component-form" data-container="#concept-component-form-container" data-toggle="popover" data-trigger="hover" title="" data-original-title="Component overview" data-placement="left">
							<i class="fa fa-question-circle" aria-hidden="true"></i>
						</a>
					</div>
					<table class="table table-striped small-table table-hover" id="component-table">
						<thead>
							<tr>
								<th>Name</th>
								<th>Version</th>
								<th>Type</th>
								<th>Logical type</th>
								<th><!-- BUTTONS --></th>
							</tr>
						</thead>
						<tbody>
							{% for component in components %}
								<tr>
									<td>{% if component.component_type == 1 %}({{ component.concept_ref_id }}) {% endif %}{{ component.name }}
										{% if component.component_type == 1 %}
											{% for item in request.BRAND_GROUPS %}
												{% for brand, groups in item.iteritems %}
													{% if component.group in groups %}
													<img src="{% static 'img/brands/' %}{{brand}}/logo.png" height="10px" title="{{brand}}" alt="{{brand}}" />
													{% endif %}
												{% endfor %}
											{% endfor %}
										{% endif %}
									</td>
									<td>{% if component.component_type == 1 %}{{ component.concept_ref_history_id }}{% else %} - {% endif %}</td>
									<td>{{ component.get_component_type_display }}</td>
									<td>{{ component.get_logical_type_display }}</td>
									<td class="text-right">
										{% if component.component_type == 1 %}
											{% if component.id in component_error_msg_view %}
						 	 				    <div class="alert-danger" role="alert" style=" display:inline-block;" >
						 	 						<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
						 	 						<span class="sr-only">Error:</span>
						 	 						{% for key,value in component_error_msg_view.items %}
						 	 						   {% if key == component.id %}
														 {% for v in value %}
														 	- {{ v }}<br> 
														 {% endfor %}
													   {% endif %}
													{% endfor %}
						 	 					</div>
											{% endif %}
											<a class="js-load-modal" href="{% url 'component_concept_detail' component.concept_id component.pk %}">
												<button type="button" class="btn btn-info btn-xs" data-container="body" data-toggle="popover" data-html="true" data-placement="left" id="code-preview-{{ component.pk }}" data-trigger="hover">
												  <i class="glyphicon glyphicon-search"> </i>
												</button>
											</a>
											   <!-- a class="js-load-modal" href="{% url 'component_concept_detail' component.concept_id component.pk %}">View</a-->
											
										{% elif component.component_type == 2 %}
												<a class="js-load-large-modal" href="{% url 'component_querybuilder_detail' component.concept_id component.pk %}">
												<button type="button" class="btn btn-info btn-xs" data-container="body" data-toggle="popover" data-html="true" data-placement="left" id="code-preview-{{ component.pk }}" data-trigger="hover">
													<i class="glyphicon glyphicon-search"> </i>
												</button>
												</a>
										<!-- a class="js-load-large-modal" href="{% url 'component_querybuilder_detail' component.concept_id component.pk %}">View</a-->
										{% elif component.component_type == 3 %}
											<a class="js-load-large-modal" href="{% url 'component_expression_detail' component.concept_id component.pk %}">
											<button type="button" class="btn btn-info btn-xs" data-container="body" data-toggle="popover" data-html="true" data-placement="left" id="code-preview-{{ component.pk }}" data-trigger="hover">
											  <i class="glyphicon glyphicon-search"> </i>
											</button>
											</a>
										<!-- a class="js-load-large-modal" href="{% url 'component_expression_detail' component.concept_id component.pk %}">View</a-->
										{% elif component.component_type == 4 %}
											<a class="js-load-large-modal" href="{% url 'component_expressionselect_detail' component.concept_id component.pk %}">			
											<button type="button" class="btn btn-info btn-xs" data-container="body" data-toggle="popover" data-html="true" data-placement="left" id="code-preview-{{ component.pk }}" data-trigger="hover">
												<i class="glyphicon glyphicon-search"> </i>
											</button>			
											</a>
										<!-- a class="js-load-large-modal" href="{% url 'component_expressionselect_detail' component.concept_id component.pk %}">View</a-->
										{% else  %}
											<p>No component type available</p>
										{% endif %}
										<!-- A hidden section containing the list of codes in the component. This will
											 be shown when the user hovers over the view icon using the Bootstrap popover
											 plugin. 
										  -->
										<div id="popover-content-code-preview-{{ component.pk }}" class="hide popover-lg">
											{% if component.component_type == 1 %}
<!-- 												<div>Concept name: {{ component.concept_ref.name }}</div> -->
<!-- 												<div>Comment: {{ component.comment }}</div> -->
												<table class="table table-striped small-table" style="margin-bottom: 0px;">
													<thead>
														<tr>
															<th>Code</th>
															<th>Description</th>
														</tr>
													</thead>
													<tbody>
													{% for code in component.codelist.codes.all|slice:":10" %}
														<tr>
															<td>{{ code.code }}</td>
															<td>{{ code.description }}</td>
														</tr>
													{% empty %}
														<tr>
															<td colspan="2" class="text-center bg-warning">
																No codes
															</td>
														</tr>
													{% endfor %}
													</tbody>
												</table>
												<div>...</div>
											{% endif %}
											{% if component.component_type == 2 %}
												<table class="table table-striped small-table" style="margin-bottom: 0px;">
													<thead>
														<tr>
															<th>Code</th>
															<th>Description</th>
														</tr>
													</thead>
													<tbody>
													{% for code in component.codelist.codes.all|slice:":10" %}
														<tr>
															<td>{{ code.code }}</td>
															<td>{{ code.description }}</td>
														</tr>
													{% empty %}
														<tr>
															<td colspan="2" class="text-center bg-warning">
																No codes
															</td>
														</tr>
													{% endfor %}
													</tbody>
												</table>
												<div>...</div>
											{% endif %}
											{% if component.component_type == 3 or component.component_type == 4 %}		
												<div><label>Regex Code:</label> {{ component.coderegex.regex_code }}</div>	
												<table class="table table-striped small-table" style="margin-bottom: 0px;">
													<thead>
														<tr>
															<th>Code</th>
															<th>Description</th>
														</tr>
													</thead>
													<tbody>
													{% for code in component.codelist.codes.all|slice:":10" %}
														<tr>
															<td>{{ code.code }}</td>
															<td>{{ code.description }}</td>
														</tr>
													{% empty %}
														<tr>
															<td colspan="2" class="text-center bg-warning">
																No codes
															</td>
														</tr>
													{% endfor %}
													</tbody>
												</table>
												<div>...</div>
											{% endif %}
										</div>
									</td>
								</tr>
							{% empty %}
								<tr>
									<td colspan="5" class="text-center bg-warning">
										No components
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
					<div class="form-group">
						<div class="col-xs-offset-3 col-xs-9">
							<a href="{% url 'concept_list' %}" class="btn btn-success">
								<i class="fa fa-undo" aria-hidden="true"></i> Return to list
							</a>
						</div>
					</div>
				</div>
				
				
	<!--	-------------------------------------------------------------------
			CHANGE HISTORY
			-------------------------------------------------------------------
	  -->
				<hr/>
				<div class="row">
					<div class="col-sm-11" id="help-concept-history-container">
						<h3><i class="fa fa-history" aria-hidden="true"></i> Change history</h3>
					</div>
					<div class="col-sm-1 text-right">
						<a href="#" role="button" class="popovers" id="help-concept-history" data-container="#help-concept-history-container" data-toggle="popover" data-trigger="hover" title="" data-original-title="Change history" data-placement="left">
							<i class="fa fa-question-circle" aria-hidden="true"></i>
						</a>
					</div>
				</div>		
				<div class="pre-scrollable">		
					<table class="table table-striped small-table table-hover" id="history-table">
						<thead>
							<tr>
								<th>Id</th>
								<th>Name</th>
								<th>Description</th>
								<th>Date</th>
<!-- 								<th>Type</th> -->
								<th>Change reason</th>
								<th>User</th>
								{% if enable_publish %}
								<th>Is Published?</th>
								{% endif %}
								<th></th>
							</tr>
						</thead>
						<tbody>
						{% include '../concept/partial_history_list.html' %}
						</tbody>
					</table>
			    </div>	
				
			</div>
		</div>
	<!--	-------------------------------------------------------------------
			HELP POP-UP TEXTS
			-------------------------------------------------------------------
	  -->
		<div id="popover-content-concept-form" class="hide popover-lg">
			<p>
				The basic entity in this system is a "concept", a group of clinical codes that defines a single meaningful event, condition, etc. within the data.
			</p>
			<p>
				Each concept is made up of one or more components. There are several types of components. A component can be simply a list of clinical codes. It can also be defined as a regex that matches a certain set of codes (for example, a regex could match a certain range of ICD10 chapters). Another concept can also be a component. This allows defining a broad concept that is made up of several more specific concepts (for example, a concept for heart disease could consist of concepts for coronary artery disease, heart attack, cardiomyopathy...).
			</p>
			<p>
				Components can be defined as inclusion or exclusion. This decides whether to include or exclude a set of codes within the concept. Excluded codes will take precedence over the same code being included in another component.
			</p>
			<p>
				You specify the coding system to use at the Concept level. For example you can query ICD10 or Read codes based on the coding system selected. 
			</p>
			<img src="{% static 'img/code-list-library-erd.png' %}" width="600px" alt="Entity relationship diagram" />
		</div>
		<div id="popover-content-concept-button-list" class="hide popover-lg">
			<p>
				<strong>Return to list</strong> - returns to the concept search page.
			</p>
			<p>
				<strong>Export</strong> - export all codes into a csv file/JSON/XML for the current concept. This will also
				take into account any code lists within related concepts. The exported codes will only contain inclusion code
				lists and exclude any code lists that have the logical type marked as exclusion(remove-codes).
				The button will be disabled unless you have permission to view <b>all</b> of the component concepts.
			</p>
			<p>
				<strong>Fork</strong> - This will take a copy of the current concept and create a new concept with all the relevant components and history copied across.
			</p>
			<p>
				<strong>Publish</strong> - This will publish the chosen version of the concept to the public on /publicsites/concepts/.
				Only owner can publish and concept must have exportable codes.
			</p>
			<!-- Tree not currently working.
			<p>
				<strong>View tree</strong> - This displays the current concept and any related concepts in a hierarchical tree view. It also displays any parent concepts that the current concept is linked to. You can navigate to any related concept by selecting the item in the tree view and clicking the relevant button. This will open the concept into a new window.
			</p>
			  -->
		</div>
		<div id="popover-content-concept-component-form" class="hide popover-lg">
			<p>
				Each concept is made up of one or more components. The different components are explained below:
			</p>
			<ul>
				<li>
					You can select codes individually using a simple query or regular expression. This will query either the code or description field. For this component you can also manually add code and descriptions to a code list by clicking the + button in the component list.
				</li>
				<li>Match codes or descriptions with a simple query or regular expression.</li>
				<li>A component can contain a list of clinical codes created by using the SQL query builder.</li>
				<li>It can also be defined as a regular expression (regex) that matches a certain set of codes (for example, a regex could match a certain range of ICD10 chapters).</li>
				<li>Another concept can also be a component. This allows defining a broad concept that is made up of several more specific concepts (for example, a concept for heart disease could consist of concepts for coronary artery disease, heart attack, cardiomyopathy...).</li>
			</ul>
			
			<p>
				Components can be defined as inclusion or exclusion components and this will determine if codes within a component will appear when querying this concept using the api or when downloading the concept csv to access the codes for a specific concept.
			</p>
		</div>
		<div id="popover-content-help-concept-history" class="hide popover-lg">
			<p>
				Every time you make a change to a concept whether it is saving concept information or adding/editing/deleting components it is audited. 
			</p>
			<p>
				You can view a concept from a specific point in time by clicking the View link at the required save point.
			</p>
			<p>
				Within the view you can revert changes and restore a concept back to a specific point in time. 
			</p>
			<p>
				You can fork and create a new concept from a specific point in time.
			</p>
		</div>
	</div>
</div>
{% endblock container %}

{% block scripts %}
	<script src="{% static 'js/clinicalcode/component.js' %}"></script>
	<script src="{% static 'js/clinicalcode/concept.js' %}"></script>
{% endblock scripts %}

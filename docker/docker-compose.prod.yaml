version: '3'

services:
  app:
    platform: linux/amd64
    image: cll/app
    restart: on-failure
    command: >
      sh -c "/home/config_cll/init-app.sh"
    ports:
      - ${app_port}:80
    expose:
      - 80
      - 443
    env_file:
      - ./env_vars.txt
    volumes:
      - ./cl_log/:/home/config_cll/cll_srvr_logs/
    depends_on:
      - redis

  engagelens:
    platform: linux/amd64
    build:
      context: .
      dockerfile: ./engagelens/app.Dockerfile
    command: >
      sh -c "/bin/wait-for-it.sh -t 0 app:80 -- gunicorn -b 0.0.0.0:8050 app:server"
    volumes:
      - ../engagelens:/engagelens
    expose:
      - 8050
    depends_on:
      - app
    env_file:
      - ./env_vars.txt

  redis:
    image: redis:7.0-bullseye
    container_name: redis
    restart: on-failure
    ports:
      - 6379:6379
    expose:
      - 6379
    networks:
      default:
        aliases:
          - redis

  celery_worker:
    image: cll/celery_worker
    restart: on-failure
    command: >
      sh -c "/home/config_cll/worker-start.sh"
    env_file:
      - ./env_vars.txt
    profiles:
      - live
    depends_on:
      - app
      - redis

  celery_beat:
    image: cll/celery_beat
    restart: on-failure
    command: >
      sh -c "/home/config_cll/beat-start.sh"
    env_file:
      - ./env_vars.txt
    profiles:
      - live
    depends_on:
      - app
      - redis
      - celery_worker

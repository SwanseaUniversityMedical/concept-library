x-app: &app-base
  platform: linux/amd64
  image: ${cll_app_image:-cll/app:latest}
  restart: always
  stop_grace_period: ${cll_grace_period:-3s}
  env_file: ./env_vars.txt
  command: >
    sh -c "/usr/bin/supervisord -c /etc/supervisord.conf"
  ports:
    - ${app_port:-80}:80
  expose:
    - 80
    - 443
  networks:
    - backend
  volumes:
    - type: volume
      source: app-logs
      target: /home/config_cll/cll_srvr_logs
  healthcheck:
    test: ["CMD-SHELL", "/bin/web-healthcheck.sh"]
    interval: 60s
    timeout: 5s
    start_period: 5s
    retries: 5

services:
  app-demo:
    container_name: app
    <<: *app-base
    profiles: ['demo']

  app-live:
    <<: *app-base
    container_name: app
    profiles: ['live']
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: ${redis_image:-redis:7.0-bullseye}
    container_name: redis
    restart: always
    stop_grace_period: ${cll_grace_period:-3s}
    ports:
      - ${redis_port:-6379}:${redis_port:-6379}
    expose:
      - ${redis_port:-6379}
    profiles:
      - live
    networks:
      - backend
    environment:
      REDIS_HOST: redis
      REDIS_PORT: ${redis_port:-6379}
    healthcheck:
      test: redis-cli ping | grep PONG
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  backend:
    name: cllnet
    driver: bridge
    attachable: true
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: ${cll_host_binding:-0.0.0.0}

volumes:
  app-logs:
    driver: local
    driver_opts:
      type: none
      device: ${cll_log_path:-./cl_log}
      o: bind
